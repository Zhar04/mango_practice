<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maango - Language Level Assessment</title>
    <!-- New Updates Favicon-->
    <link rel="icon" href="/assets/icons/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/assets/icons/favicon-32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="/assets/icons/favicon-48.png" sizes="48x48" type="image/png">
    <link rel="apple-touch-icon" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" href="/assets/icons/android-192.png" sizes="192x192">
    <link rel="icon" href="/assets/icons/android-512.png" sizes="512x512">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Google Generative AI SDK -->
<script src="https://cdn.jsdelivr.net/npm/@google/generative-ai@latest/dist/index.umd.min.js"></script>
    <script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
</script>
    <!-- docx library for Word export -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #fef6f0 0%, #f0f4ff 100%); min-height: 100vh; }
        
        /* Loading Overlay */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; color: #64748b; font-size: 16px; }
        .connection-status { position: fixed; bottom: 20px; right: 20px; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 1000; }
        .connection-status.online { background: #dcfce7; color: #166534; }
        .connection-status.offline { background: #fee2e2; color: #dc2626; }
        
        /* Top Navigation */
        .top-nav { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .top-nav .logo { display: flex; align-items: center; gap: 10px; font-size: 1.4em; font-weight: 700; color: #2c3e50; }
        .top-nav .nav-links { display: flex; gap: 8px; }
        .top-nav .nav-link { padding: 10px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-size: 0.95em; color: #64748b; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .top-nav .nav-link:hover { background: #f1f5f9; }
        .top-nav .nav-link.active { background: #eff6ff; color: #3b82f6; font-weight: 600; }
        
        /* Notification */
        .notification { position: fixed; top: 80px; right: 20px; padding: 14px 28px; border-radius: 10px; color: white; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; animation: slideIn 0.3s ease; display: none; }
        .notification.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .notification.show { display: block; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Layout */
        .main-container { display: flex; min-height: calc(100vh - 60px); }
        .sidebar { width: 260px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding: 30px 20px; position: fixed; height: calc(100vh - 60px); overflow-y: auto; top: 60px; }
        .sidebar h2 { color: #2c3e50; margin-bottom: 25px; font-size: 1.3em; }
        .sidebar-item { padding: 15px 20px; margin: 10px 0; border-radius: 10px; cursor: pointer; transition: all 0.3s; background: #f8f9fa; border-left: 4px solid transparent; }
        .sidebar-item:hover { background: #fff5f0; border-left-color: #ff8c00; transform: translateX(5px); }
        .sidebar-item.active { background: linear-gradient(135deg, #fff5f0 0%, #f0f7ff 100%); border-left-color: #3498db; font-weight: 600; }
        .sidebar-item.completed { background: #e8f5e9; border-left-color: #4caf50; }
        .content { margin-left: 260px; padding: 40px; flex: 1; }
        .content.full-width { margin-left: 0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 40px; }
        .container.wide { max-width: 1200px; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 40px; font-size: 1.1em; }
        
        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid; }
        .stat-card .icon { font-size: 28px; margin-bottom: 10px; }
        .stat-card .value { font-size: 32px; font-weight: 700; }
        .stat-card .label { color: #64748b; font-size: 14px; margin-top: 4px; }
        .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 30px; }
        .action-btn { padding: 20px 24px; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; color: white; display: flex; align-items: center; gap: 12px; transition: all 0.3s; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .action-btn.blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .action-btn.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .action-btn.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .dashboard-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .dashboard-card h3 { font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 16px; }
        .lesson-item, .assessment-item { padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .item-info .name { font-weight: 600; color: #1e293b; }
        .item-info .details { font-size: 14px; color: #64748b; margin-top: 4px; }
        .score-badge { padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .score-badge.high { background: #dcfce7; color: #166534; }
        .score-badge.medium { background: #fef3c7; color: #92400e; }
        .score-badge.low { background: #fee2e2; color: #dc2626; }
        
        /* Forms & Buttons */
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .view-header h2 { font-size: 28px; font-weight: 700; color: #1e293b; }
        .form-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .form-input, .form-select, .form-textarea { padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-family: inherit; transition: border-color 0.3s; width: 100%; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3b82f6; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }
        .btn-secondary { background: #f1f5f9; color: #64748b; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .lesson-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #3b82f6; }
        .lesson-card.completed { border-left-color: #10b981; }
        .lesson-card.cancelled { border-left-color: #ef4444; }
        .lesson-actions { display: flex; gap: 8px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        
        /* Calendar */
        .instructions-box { background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        .instructions-box h4 { color: #166534; margin-bottom: 12px; }
        .instructions-box ol { color: #15803d; margin-left: 20px; line-height: 1.8; }
        .ics-textarea { width: 100%; height: 200px; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: 'Consolas', monospace; font-size: 13px; resize: vertical; }
        .events-list { max-height: 400px; overflow-y: auto; margin-top: 20px; }
        .event-card { padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Current Lesson Banner */
        .current-lesson-banner { background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 16px 24px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .current-lesson-banner .info { display: flex; align-items: center; gap: 12px; }
        .current-lesson-banner .icon { font-size: 24px; }
        .current-lesson-banner .text strong { color: #1e40af; display: block; }
        .current-lesson-banner .text span { color: #3b82f6; font-size: 14px; }
        
        /* Session Timer */
        .session-timer { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 12px 20px; display: flex; align-items: center; gap: 10px; font-weight: 600; color: #92400e; }
        .session-timer .timer-icon { font-size: 20px; }
        .session-timer .timer-value { font-size: 1.3em; font-family: 'Consolas', monospace; }
        
        /* Google Meet Button */
        .meet-btn { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 14px 24px; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .meet-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); }
        .meet-btn.copied { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .meet-section { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .meet-link-display { background: white; padding: 12px 16px; border-radius: 8px; margin-top: 12px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #e2e8f0; }
        .meet-link-display input { flex: 1; border: none; font-size: 14px; color: #1e293b; background: transparent; }
        .copy-link-btn { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .copy-link-btn:hover { background: #2563eb; }
        
        /* Test Sections */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .level-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px auto; max-width: 900px; }
        .variant-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px auto; max-width: 600px; }
        .card { background: linear-gradient(135deg, #fff5f0 0%, #f0f7ff 100%); border: 2px solid #e0e0e0; border-radius: 15px; padding: 30px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(255, 140, 0, 0.2); border-color: #ff8c00; }
        .card h3 { color: #2c3e50; margin-bottom: 10px; font-size: 1.5em; }
        .card p { color: #7f8c8d; line-height: 1.6; }
        .question { background: #fafafa; padding: 25px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ff8c00; }
        .question h4 { color: #2c3e50; margin-bottom: 15px; font-size: 1.1em; }
        .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .question-header h4 { margin-bottom: 0; }
        .hint-btn { background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border: 1px solid #ffc107; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; flex-shrink: 0; }
        .hint-btn:hover { background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); transform: scale(1.1); box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4); }
        .answer-key { display: none; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #4caf50; border-radius: 8px; padding: 12px 15px; margin-top: 15px; color: #2e7d32; font-weight: 500; }
        .answer-key.show { display: block; animation: fadeIn 0.3s; }
        .options { margin-top: 15px; }
        .option { display: block; margin: 10px 0; }
        .option input { margin-right: 10px; }
        .option label { cursor: pointer; color: #34495e; }
        textarea, input[type="text"] { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; font-family: inherit; margin-top: 10px; resize: vertical; }
        textarea:focus, input[type="text"]:focus { outline: none; border-color: #ff8c00; }
        .media-container { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .audio-player, .video-player { width: 100%; max-width: 100%; border-radius: 10px; margin-top: 10px; }
        .chart-image { max-width: 100%; height: auto; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .reading-text { background: white; padding: 25px; border-radius: 10px; line-height: 1.8; margin: 20px 0; border: 2px solid #e0e0e0; }
        .cue-card { background: linear-gradient(135deg, #fff9e6 0%, #ffe6f0 100%); padding: 25px; border-radius: 12px; margin: 20px 0; border: 2px dashed #ff8c00; }
        .results { background: #f8f9fa; padding: 30px; border-radius: 15px; margin: 20px 0; }
        .result-section { background: white; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #3498db; }
        .result-section h3 { color: #2c3e50; margin-bottom: 15px; }
        .score { font-size: 2em; font-weight: bold; color: #ff8c00; margin: 10px 0; }
        .recommendation { background: #fff3e0; padding: 15px; border-radius: 8px; margin: 10px 0; color: #e65100; }
        .grammar-topic { background: #e3f2fd; padding: 12px; border-radius: 8px; margin: 8px 0; color: #1565c0; border-left: 3px solid #2196f3; }
        .nav-btn { background: #3498db; color: white; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: all 0.3s; margin-top: 20px; }
        .nav-btn:hover { background: #2980b9; transform: scale(1.05); }
        .nav-btn.primary { background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%); }
        .nav-btn.primary:hover { background: linear-gradient(135deg, #ff6b00 0%, #ff4500 100%); }
        .instruction-note { background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0; color: #2e7d32; border-left: 4px solid #4caf50; }
        .show-answers-btn { background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: all 0.3s; margin: 20px 0; display: inline-flex; align-items: center; gap: 8px; }
        .show-answers-btn:hover { background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); transform: scale(1.05); }
        .show-answers-btn.active { background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); }
        .option.correct-answer { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; padding: 8px 12px; margin: 5px 0; border-left: 4px solid #4caf50; }
        .option.wrong-answer { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-radius: 8px; padding: 8px 12px; margin: 5px 0; border-left: 4px solid #f44336; }
        .answer-indicator { font-size: 0.85em; margin-left: 10px; font-weight: bold; }
        .answer-indicator.correct { color: #2e7d32; }
        .answer-indicator.wrong { color: #c62828; }
        .input-answer-display { margin-top: 10px; padding: 12px; border-radius: 8px; display: none; }
        .input-answer-display.show { display: block; }
        .input-answer-display.correct { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #4caf50; color: #2e7d32; }
        .input-answer-display.wrong { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 4px solid #f44336; color: #c62828; }
        .writing-answer-btn { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.95em; transition: all 0.3s; margin-top: 15px; }
        .writing-answer-container { display: none; margin-top: 15px; padding: 20px; background: #fafafa; border-radius: 10px; border: 2px solid #e0e0e0; }
        .writing-answer-container.show { display: block; }
        .export-section { background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 2px solid #7c4dff; }
        .export-fields { display: grid; gap: 15px; margin-bottom: 20px; }
        .field-group { display: flex; flex-direction: column; gap: 5px; }
        .field-group label { font-weight: 600; color: #2c3e50; font-size: 0.95em; }
        .export-btn { background: linear-gradient(135deg, #7c4dff 0%, #651fff 100%); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; }
        .export-btn:hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(124, 77, 255, 0.4); }
        .export-btn:disabled { background: #bdbdbd; cursor: not-allowed; }
        .save-db-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; margin-left: 15px; }
        .save-db-btn:hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4); }
        .match-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .match-item { padding: 12px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: relative; height: auto; top: 0; }
            .content { margin-left: 0; padding: 20px; }
            h1 { font-size: 1.8em; }
            .level-selector, .variant-selector { grid-template-columns: 1fr; }
            .main-container { flex-direction: column; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .quick-actions, .dashboard-grid, .form-grid { grid-template-columns: 1fr; }
            .top-nav { flex-direction: column; gap: 10px; }
            .top-nav .nav-links { flex-wrap: wrap; justify-content: center; }
        }
        
        /* AI Feedback Styles */
        .ai-feedback-card, .ai-recommendations-card { background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%); border: 1px solid #4285f4; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15); }
        .ai-feedback-header { display: flex; align-items: center; gap: 10px; font-weight: 600; color: #1a73e8; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid rgba(66, 133, 244, 0.2); font-size: 1.1em; flex-wrap: wrap; }
        .ai-icon { font-size: 1.4em; }
        .ai-disclaimer { font-size: 0.7em; color: #666; font-weight: normal; margin-left: auto; background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 4px; }
        .ai-feedback-section { margin: 12px 0; padding: 12px; background: rgba(255, 255, 255, 0.7); border-radius: 8px; }
        .ai-feedback-section strong { color: #333; display: block; margin-bottom: 6px; }
        .ai-feedback-section p { margin: 0; color: #444; line-height: 1.5; }
        .ai-feedback-section ul { margin: 8px 0 0 20px; padding: 0; }
        .ai-feedback-section li { margin: 6px 0; color: #444; line-height: 1.4; }
        .ai-strengths { border-left: 4px solid #34a853; background: rgba(52, 168, 83, 0.08); }
        .ai-improvements { border-left: 4px solid #ea8600; background: rgba(251, 188, 4, 0.08); }
        .ai-score-suggestion { background: rgba(251, 188, 4, 0.12); border-left: 4px solid #fbbc04; }
        .ai-cefr-suggestion { background: rgba(66, 133, 244, 0.1); border-left: 4px solid #4285f4; }
        .cefr-badge { display: inline-block; background: #1a73e8; color: white; padding: 2px 10px; border-radius: 12px; font-weight: bold; margin: 0 4px; }
        .ai-teacher-tip { background: rgba(52, 168, 83, 0.1); border-left: 4px solid #34a853; }
        .ai-priority { background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800; margin-bottom: 15px; font-size: 1.05em; }
        .ai-feedback-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 15px 0; }
        .ai-feedback-item { background: rgba(255, 255, 255, 0.8); padding: 14px; border-radius: 8px; border-left: 3px solid #4285f4; }
        .ai-feedback-item strong { color: #1a73e8; display: block; margin-bottom: 6px; }
        .ai-feedback-item p { margin: 0; font-size: 0.95em; color: #444; }
        .ai-weekly-plan .week-plan { display: grid; gap: 10px; margin-top: 10px; }
        .ai-weekly-plan .week { background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 6px; border-left: 3px solid #4285f4; }
        .exercises-list { margin-top: 10px; }
        .exercise-item { display: grid; grid-template-columns: 100px 1fr auto; gap: 10px; padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 6px; margin-bottom: 8px; align-items: center; }
        .exercise-skill { background: #e8f0fe; color: #1a73e8; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500; text-transform: capitalize; }
        .resources-list { list-style: none; padding: 0; margin: 10px 0 0 0; }
        .resources-list li { background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #34a853; }
        .resources-list a { color: #1a73e8; word-break: break-all; }
        .ai-milestones .milestones-list { margin-top: 10px; }
        .milestone { display: flex; gap: 15px; padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 6px; margin-bottom: 8px; align-items: center; flex-wrap: wrap; }
        .milestone-time { background: #4285f4; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500; }
        .ai-encouragement { background: linear-gradient(135deg, rgba(52, 168, 83, 0.1), rgba(52, 168, 83, 0.05)); padding: 18px; border-radius: 10px; text-align: center; font-size: 1.05em; color: #2e7d32; margin-top: 15px; border: 1px solid rgba(52, 168, 83, 0.2); }
        .ai-assist-btn { background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s ease; min-width: 200px; margin-top: 15px; }
        .ai-assist-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(66, 133, 244, 0.35); }
        .ai-assist-btn:disabled { background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%); cursor: not-allowed; transform: none; }
        .ai-assist-btn.loading::after { content: ''; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 8px; }
        .ai-loading { text-align: center; padding: 30px; color: #1a73e8; }
        .ai-loading::before { content: ''; display: block; width: 40px; height: 40px; margin: 0 auto 15px; border: 3px solid #e8f0fe; border-top-color: #4285f4; border-radius: 50%; animation: spin 1s linear infinite; }
        .ai-error { text-align: center; padding: 20px; color: #d93025; background: rgba(217, 48, 37, 0.08); border-radius: 8px; border: 1px solid rgba(217, 48, 37, 0.2); }
        .ai-section { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e0e0e0; }
        .ai-section-title { font-size: 0.9em; color: #666; margin-bottom: 12px; }
        .ai-section-title::before { content: 'ü§ñ '; }
        .notification.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        @media (max-width: 768px) {
            .ai-feedback-grid { grid-template-columns: 1fr; }
            .exercise-item { grid-template-columns: 1fr; }
            .ai-assist-btn { width: 100%; }
            .ai-disclaimer { width: 100%; margin-left: 0; margin-top: 8px; text-align: center; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Connecting to database...</div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status online" id="connectionStatus">üü¢ Connected</div>

    <!-- Top Navigation -->
    <nav class="top-nav" id="topNav">
        <div class="logo"><span>üìö</span><span>Language Assessment</span></div>
        <div class="nav-links">
            <button class="nav-link active" onclick="showView('dashboard')" data-view="dashboard">üè† Dashboard</button>
            <button class="nav-link" onclick="showView('lessons')" data-view="lessons">üìÖ Lessons</button>
            <button class="nav-link" onclick="showView('history')" data-view="history">üìä History</button>
        </div>
    </nav>
    <div class="notification" id="notification"></div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="view-container">
        <div class="content full-width">
            <div class="container wide">
                <h1>üìä Dashboard</h1>
                <p class="subtitle">Manage lessons, track progress, and view assessment history ‚Ä¢ <span style="color:#10b981">‚òÅÔ∏è Cloud Synced</span></p>
                <div class="stats-grid" id="statsGrid"></div>
                <div class="quick-actions">
                    <button class="action-btn blue" onclick="showView('lessons')"><span style="font-size:24px">‚ûï</span> New Lesson</button>
                    <button class="action-btn orange" onclick="startQuickAssessment()"><span style="font-size:24px">üìù</span> Quick Assessment</button>
                    <button class="action-btn" onclick="clearAllLessons()" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%)"><span style="font-size:24px">üóëÔ∏è</span> Clear All Lessons</button>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card"><h3>üìÖ Upcoming Lessons</h3><div id="upcomingLessons"></div></div>
                    <div class="dashboard-card"><h3>üìä Recent Assessments</h3><div id="recentAssessments"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lessons View -->
    <div id="lessonsView" class="view-container" style="display:none">
        <div class="content full-width">
            <div class="container wide">
                <div class="view-header"><h2>üìÖ Lessons</h2><button class="btn btn-primary" onclick="toggleLessonForm()">+ Add Lesson</button></div>
                <div class="form-card" id="lessonForm" style="display:none">
                    <h3 style="margin-bottom:16px;color:#1e293b">Create New Lesson</h3>
                    <div class="form-grid">
                        <input type="text" class="form-input" id="newStudentName" placeholder="Student Name *">
                        <input type="tel" class="form-input" id="newPhone" placeholder="Phone Number">
                    </div>
                    <div class="form-grid" style="margin-top:16px">
                        <input type="datetime-local" class="form-input" id="newDateTime">
                        <select class="form-select" id="newLevel"><option value="">Select Level</option><option value="A0">A0 - Beginner</option><option value="B1/B2">B1/B2 - Intermediate</option><option value="IELTS">IELTS - Advanced</option></select>
                    </div>
                    <textarea class="form-textarea" id="newNotes" placeholder="Notes (optional)" style="margin-top:16px"></textarea>
                    <div style="margin-top:16px;display:flex;gap:12px">
                        <button class="btn btn-success" onclick="createLesson()">Create Lesson</button>
                        <button class="btn btn-secondary" onclick="toggleLessonForm()">Cancel</button>
                    </div>
                </div>
                <div id="lessonsList"></div>
            </div>
        </div>
    </div>

    <!-- History View -->
    <div id="historyView" class="view-container" style="display:none">
        <div class="content full-width">
            <div class="container wide">
                <div class="view-header">
                    <h2>üìä Assessment History</h2>
                    <button class="btn btn-danger" onclick="clearAllHistory()" id="clearHistoryBtn">üóëÔ∏è Clear All History</button>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- Initial Screens -->
    <div id="initialScreens" style="display:none">
        <div class="content full-width">
            <div class="container">
                <div class="current-lesson-banner" id="currentLessonBanner" style="display:none">
                    <div class="info"><span class="icon">üë§</span><div class="text"><strong id="bannerStudentName">Student</strong><span id="bannerLessonDetails">Details</span></div></div>
                    <button class="btn btn-secondary" onclick="clearCurrentLesson()">Cancel</button>
                </div>
                <h1>Language Level Assessment</h1>
                <p class="subtitle">Comprehensive English Proficiency Test</p>
                <div id="levelSelection" class="section active">
                    <h2 style="color:#2c3e50;margin-bottom:20px">Choose Your Level</h2>
                    <div class="level-selector">
                        <div class="card" onclick="selectLevel('A0')"><h3>üå± A0 - Beginner</h3><p>Basic vocabulary and simple sentences</p></div>
                        <div class="card" onclick="selectLevel('B1/B2')"><h3>üìö B1/B2 - Intermediate</h3><p>Everyday situations, complex sentences</p></div>
                        <div class="card" onclick="selectLevel('IELTS')"><h3>üéì IELTS - Advanced</h3><p>Academic English, complex topics</p></div>
                    </div>
                </div>
                <div id="variantSelection" class="section">
                    <h2 style="color:#2c3e50;margin-bottom:20px">Choose Practice Variant</h2>
                    <div class="variant-selector">
                        <div class="card" onclick="selectVariant(1)"><h3>Variant 1</h3><p>Complete test set</p></div>
                        <div class="card" onclick="selectVariant(2)"><h3>Variant 2</h3><p>Complete test set</p></div>
                        <div class="card" onclick="selectVariant(3)"><h3>Variant 3</h3><p>Complete test set</p></div>
                        <div class="card" onclick="selectVariant(4)"><h3>Variant 4</h3><p>Complete test set</p></div>
                    </div>
                    <div class="meet-section" id="meetSection">
                        <h4 style="color:#166534;margin-bottom:12px">üìπ Google Meet for Online Session</h4>
                        <p style="color:#64748b;font-size:14px;margin-bottom:12px">Opens Google Meet where you can start an instant meeting and copy the link.</p>
                        <button class="meet-btn" onclick="openGoogleMeet()">
                            <span>üé•</span> Open Google Meet
                        </button>
                    </div>
                    <button class="nav-btn" onclick="backToLevelSelection()" style="background:#95a5a6;margin-top:20px">‚Üê Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Interface -->
    <div id="testInterface" class="main-container" style="display:none">
        <div class="sidebar">
            <h2>Test Sections</h2>
            <div class="session-timer" id="sessionTimer">
                <span class="timer-icon">‚è±Ô∏è</span>
                <span class="timer-value" id="timerDisplay">00:00:00</span>
            </div>
            <div class="sidebar-item" onclick="navigateToSection('Listening')" id="nav-Listening">üéß Listening</div>
            <div class="sidebar-item" onclick="navigateToSection('Reading')" id="nav-Reading">üìñ Reading</div>
            <div class="sidebar-item" onclick="navigateToSection('Writing')" id="nav-Writing">‚úçÔ∏è Writing</div>
            <div class="sidebar-item" onclick="navigateToSection('Speaking')" id="nav-Speaking">üó£Ô∏è Speaking</div>
            <div class="sidebar-item" onclick="navigateToSection('Grammar')" id="nav-Grammar">üìù Grammar</div>
            <button class="nav-btn primary" onclick="showResults()" style="width:100%;margin-top:30px">View Results</button>
            <button class="nav-btn" onclick="backToMainMenu()" style="width:100%;margin-top:10px;background:#95a5a6">üè† Back</button>
        </div>
        <div class="content">
            <div class="container">
                <div class="current-lesson-banner" id="testLessonBanner" style="display:none;margin-bottom:20px">
                    <div class="info"><span class="icon">üë§</span><div class="text"><strong id="testBannerName">Student</strong><span id="testBannerDetails">Details</span></div></div>
                </div>
                <div id="testContent"></div>
            </div>
        </div>
    </div>

    <!-- Results Interface -->
    <div id="resultsInterface" style="display:none">
        <div class="content full-width">
            <div class="container">
                <h1>Your Assessment Results</h1>
                <p class="subtitle">Detailed Performance Analysis</p>
                <div class="export-section">
                    <h3 style="color:#2c3e50;margin-bottom:15px">üìÑ Export & Save Results</h3>
                    <div class="export-fields">
                        <div class="field-group"><label for="studentName">Student Name:</label><input type="text" id="studentName" placeholder="Enter student name..."></div>
                        <div class="field-group"><label for="testDescription">Notes:</label><textarea id="testDescription" rows="3" placeholder="Add notes..."></textarea></div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:15px">
                        <button class="export-btn" onclick="exportToWord()">üì• Export to Word</button>
                        <button class="save-db-btn" onclick="saveResultToDatabase()">üíæ Save to Cloud</button>
                    </div>
                </div>
                <div id="resultsContent"></div>
                <div class="ai-section" style="margin: 30px 0; padding: 25px; background: linear-gradient(135deg, #e8f5e9 0%, #e3f2fd 100%); border-radius: 15px; border: 2px solid #4285f4;">
                    <h3 style="color: #1a73e8; margin-bottom: 15px;">ü§ñ AI-Powered Study Plan</h3>
                    <p style="color: #666; margin-bottom: 15px;">Generate a personalized study plan based on the assessment results.</p>
                    <button id="aiRecommendationsBtn" class="ai-assist-btn" onclick="getEnhancedRecommendations()">üéØ Generate Personalized Study Plan</button>
                    <div id="aiEnhancedRecommendations"></div>
                </div>
                <div style="display:flex;gap:15px;margin-top:20px;flex-wrap:wrap">
                    <button class="nav-btn primary" onclick="restartTest()">Take Another Test</button>
                    <button class="nav-btn" onclick="showView('dashboard')" style="background:#3b82f6">üè† Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBgG6A2jm735kNCSUdB8-PJHLqO4LmXuK8",
            authDomain: "language-assessment-ccd07.firebaseapp.com",
            projectId: "language-assessment-ccd07",
            storageBucket: "language-assessment-ccd07.firebasestorage.app",
            messagingSenderId: "195576010412",
            appId: "1:195576010412:web:b38f18754a1bb5e8aef109",
            measurementId: "G-30XN8C3L8Q"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Collections references
        const lessonsCollection = db.collection('lessons');
        const assessmentsCollection = db.collection('assessments');

        // ============================================
        // GLOBAL STATE
        // ============================================
        let selectedLevel = '';
        let selectedVariant = 0;
        let currentSection = 'Listening';
        let answers = {};
        let completedSections = new Set();
        const sections = ['Listening', 'Reading', 'Writing', 'Speaking', 'Grammar'];
        let lessons = [];
        let assessmentHistory = [];
        let currentLesson = null;
        let isOnline = true;
        
        // Session Timer
        let sessionStartTime = null;
        let sessionTimerInterval = null;

        // ============================================
        // FIREBASE DATABASE FUNCTIONS
        // ============================================
        
        // Load all lessons from Firebase
        async function loadLessonsFromFirebase() {
            try {
                const snapshot = await lessonsCollection.orderBy('createdAt', 'desc').get();
                lessons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Loaded', lessons.length, 'lessons from Firebase');
            } catch (error) {
                console.error('Error loading lessons:', error);
                showNotification('Error loading lessons', 'error');
            }
        }

        // Load all assessments from Firebase
        async function loadAssessmentsFromFirebase() {
            try {
                const snapshot = await assessmentsCollection.orderBy('date', 'desc').get();
                assessmentHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Loaded', assessmentHistory.length, 'assessments from Firebase');
            } catch (error) {
                console.error('Error loading assessments:', error);
                showNotification('Error loading assessments', 'error');
            }
        }

        // Add a lesson to Firebase
        async function addLessonToFirebase(lessonData) {
            try {
                const docRef = await lessonsCollection.add({
                    ...lessonData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error adding lesson:', error);
                showNotification('Error saving lesson', 'error');
                return null;
            }
        }

        // Update a lesson in Firebase
        async function updateLessonInFirebase(lessonId, updates) {
            try {
                await lessonsCollection.doc(lessonId).update(updates);
                return true;
            } catch (error) {
                console.error('Error updating lesson:', error);
                showNotification('Error updating lesson', 'error');
                return false;
            }
        }

        // Delete a lesson from Firebase
        async function deleteLessonFromFirebase(lessonId) {
            try {
                await lessonsCollection.doc(lessonId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting lesson:', error);
                showNotification('Error deleting lesson', 'error');
                return false;
            }
        }

        // Add an assessment to Firebase
        async function addAssessmentToFirebase(assessmentData) {
            try {
                const docRef = await assessmentsCollection.add({
                    ...assessmentData,
                    date: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error adding assessment:', error);
                showNotification('Error saving assessment', 'error');
                return null;
            }
        }

        // Delete an assessment from Firebase
        async function deleteAssessmentFromFirebase(assessmentId) {
            try {
                await assessmentsCollection.doc(assessmentId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting assessment:', error);
                showNotification('Error deleting assessment', 'error');
                return false;
            }
        }

        // Real-time listener for lessons
        function setupLessonsListener() {
            lessonsCollection.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                lessons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Update UI if on dashboard or lessons view
                if (document.getElementById('dashboardView').style.display !== 'none') {
                    renderDashboard();
                }
                if (document.getElementById('lessonsView').style.display !== 'none') {
                    renderLessonsList();
                }
            }, error => {
                console.error('Lessons listener error:', error);
                updateConnectionStatus(false);
            });
        }

        // Real-time listener for assessments
        function setupAssessmentsListener() {
            assessmentsCollection.orderBy('date', 'desc').onSnapshot(snapshot => {
                assessmentHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Update UI if on dashboard or history view
                if (document.getElementById('dashboardView').style.display !== 'none') {
                    renderDashboard();
                }
                if (document.getElementById('historyView').style.display !== 'none') {
                    renderHistoryList();
                }
            }, error => {
                console.error('Assessments listener error:', error);
                updateConnectionStatus(false);
            });
        }

        // Update connection status indicator
        function updateConnectionStatus(online) {
            isOnline = online;
            const status = document.getElementById('connectionStatus');
            if (online) {
                status.className = 'connection-status online';
                status.innerHTML = 'üü¢ Connected';
            } else {
                status.className = 'connection-status offline';
                status.innerHTML = 'üî¥ Offline';
            }
        }

        // ============================================
        // NOTIFICATION
        // ============================================
        function showNotification(msg, type = 'success') {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = 'notification ' + type + ' show';
            const timeout = type === 'info' ? 10000 : 3000;
            setTimeout(() => n.classList.remove('show'), timeout);
        }

        // ============================================
        // VIEW MANAGEMENT
        // ============================================
        function showView(viewName) {
            document.querySelectorAll('.view-container').forEach(v => v.style.display = 'none');
            document.getElementById('initialScreens').style.display = 'none';
            document.getElementById('testInterface').style.display = 'none';
            document.getElementById('resultsInterface').style.display = 'none';
            document.getElementById('topNav').style.display = 'flex';
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.view === viewName) link.classList.add('active');
            });
            switch(viewName) {
                case 'dashboard': document.getElementById('dashboardView').style.display = 'block'; renderDashboard(); break;
                case 'lessons': document.getElementById('lessonsView').style.display = 'block'; renderLessonsList(); break;
                case 'history': document.getElementById('historyView').style.display = 'block'; renderHistoryList(); break;
                case 'test': document.getElementById('initialScreens').style.display = 'block'; document.getElementById('topNav').style.display = 'none'; break;
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function renderDashboard() {
            const stats = {
                totalLessons: lessons.length,
                completedLessons: lessons.filter(l => l.status === 'completed').length,
                totalAssessments: assessmentHistory.length,
                avgScore: assessmentHistory.length > 0 ? Math.round(assessmentHistory.reduce((a, b) => a + (b.percentage || 0), 0) / assessmentHistory.length) : 0
            };
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card" style="border-left-color:#3b82f6"><div class="icon">üìÖ</div><div class="value" style="color:#3b82f6">${stats.totalLessons}</div><div class="label">Total Lessons</div></div>
                <div class="stat-card" style="border-left-color:#10b981"><div class="icon">‚úÖ</div><div class="value" style="color:#10b981">${stats.completedLessons}</div><div class="label">Completed</div></div>
                <div class="stat-card" style="border-left-color:#8b5cf6"><div class="icon">üìä</div><div class="value" style="color:#8b5cf6">${stats.totalAssessments}</div><div class="label">Assessments</div></div>
                <div class="stat-card" style="border-left-color:#f59e0b"><div class="icon">üéØ</div><div class="value" style="color:#f59e0b">${stats.avgScore}%</div><div class="label">Avg Score</div></div>`;
            
            const upcoming = lessons.filter(l => l.status === 'scheduled').sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime)).slice(0,5);
            document.getElementById('upcomingLessons').innerHTML = upcoming.length === 0 
                ? '<div class="empty-state"><div class="icon">üìÖ</div><p>No upcoming lessons</p></div>'
                : upcoming.map(l => `<div class="lesson-item"><div class="item-info"><div class="name">${escapeHtml(l.studentName)||'Unnamed'}</div><div class="details">${formatDate(l.dateTime)} ‚Ä¢ ${l.level||'TBD'}</div></div><button class="btn btn-primary" onclick="startLessonAssessment('${l.id}')" style="padding:8px 16px;font-size:14px">Start</button></div>`).join('');
            
            const recent = assessmentHistory.slice(0,5);
            document.getElementById('recentAssessments').innerHTML = recent.length === 0
                ? '<div class="empty-state"><div class="icon">üìä</div><p>No assessments yet</p></div>'
                : recent.map(a => `<div class="assessment-item"><div class="item-info"><div class="name">${escapeHtml(a.studentName)}</div><div class="details">${a.level} ‚Ä¢ ${formatDate(a.date?.toDate ? a.date.toDate() : a.date)}</div></div><div class="score-badge ${a.percentage>=60?'high':a.percentage>=40?'medium':'low'}">${a.percentage}%</div></div>`).join('');
        }

        // ============================================
        // LESSONS MANAGEMENT
        // ============================================
        function toggleLessonForm() { const f = document.getElementById('lessonForm'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
        
        async function createLesson() {
            const name = document.getElementById('newStudentName').value.trim();
            if (!name) { showNotification('Enter student name', 'error'); return; }
            
            const lessonData = {
                studentName: name,
                phone: document.getElementById('newPhone').value.trim(),
                dateTime: document.getElementById('newDateTime').value || new Date().toISOString(),
                level: document.getElementById('newLevel').value,
                notes: document.getElementById('newNotes').value.trim(),
                status: 'scheduled',
                assessmentId: null
            };

            showNotification('Saving to cloud...', 'success');
            const docId = await addLessonToFirebase(lessonData);
            
            if (docId) {
                // Clear form
                document.getElementById('newStudentName').value = '';
                document.getElementById('newPhone').value = '';
                document.getElementById('newDateTime').value = '';
                document.getElementById('newLevel').value = '';
                document.getElementById('newNotes').value = '';
                toggleLessonForm();
                showNotification('Lesson saved to cloud! ‚òÅÔ∏è');
            }
        }

        async function deleteLesson(id) { 
            if(confirm('Delete this lesson?')) { 
                const success = await deleteLessonFromFirebase(id);
                if (success) {
                    showNotification('Lesson deleted');
                }
            } 
        }
        
        function startLessonAssessment(id) {
            // Stop any running timer
            stopSessionTimer();
            sessionStartTime = null;
            
            // Get the lesson
            currentLesson = lessons.find(l => l.id === id);
            if (currentLesson && currentLesson.level) selectedLevel = currentLesson.level;
            else selectedLevel = '';
            
            // Reset all state
            selectedVariant = 0;
            answers = {};
            completedSections = new Set();
            currentSection = 'Listening';
            
            // Clear UI elements
            document.getElementById('testContent').innerHTML = '';
            document.getElementById('resultsContent').innerHTML = '';
            
            // Clear export fields
            const studentNameField = document.getElementById('studentName');
            const descriptionField = document.getElementById('testDescription');
            if (studentNameField) studentNameField.value = currentLesson ? currentLesson.studentName : '';
            if (descriptionField) descriptionField.value = '';
            
            // Reset timer display
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) timerDisplay.textContent = '00:00:00';
            
            // Reset sidebar - remove active and completed classes
            sections.forEach(s => {
                const navItem = document.getElementById(`nav-${s}`);
                if (navItem) {
                    navItem.classList.remove('active', 'completed');
                }
            });
            
            updateCurrentLessonBanner();
            showView('test');
            
            if (selectedLevel) {
                document.getElementById('levelSelection').classList.remove('active');
                document.getElementById('variantSelection').classList.add('active');
            } else {
                document.getElementById('levelSelection').classList.add('active');
                document.getElementById('variantSelection').classList.remove('active');
            }
        }

        function startQuickAssessment() {
            // Stop any running timer
            stopSessionTimer();
            sessionStartTime = null;
            
            // Reset all state
            currentLesson = null;
            selectedLevel = '';
            selectedVariant = 0;
            answers = {};
            completedSections = new Set();
            currentSection = 'Listening';
            
            // Clear UI elements
            document.getElementById('currentLessonBanner').style.display = 'none';
            document.getElementById('testContent').innerHTML = '';
            document.getElementById('resultsContent').innerHTML = '';
            
            // Clear export fields
            const studentNameField = document.getElementById('studentName');
            const descriptionField = document.getElementById('testDescription');
            if (studentNameField) studentNameField.value = '';
            if (descriptionField) descriptionField.value = '';
            
            // Reset timer display
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) timerDisplay.textContent = '00:00:00';
            
            // Reset sidebar - remove active and completed classes
            sections.forEach(s => {
                const navItem = document.getElementById(`nav-${s}`);
                if (navItem) {
                    navItem.classList.remove('active', 'completed');
                }
            });
            
            // Show test view
            showView('test');
            document.getElementById('levelSelection').classList.add('active');
            document.getElementById('variantSelection').classList.remove('active');
        }

        function updateCurrentLessonBanner() {
            if (currentLesson) {
                document.getElementById('currentLessonBanner').style.display = 'flex';
                document.getElementById('bannerStudentName').textContent = currentLesson.studentName;
                document.getElementById('bannerLessonDetails').textContent = (currentLesson.level||'TBD') + ' ‚Ä¢ ' + formatDate(currentLesson.dateTime);
                document.getElementById('testLessonBanner').style.display = 'flex';
                document.getElementById('testBannerName').textContent = currentLesson.studentName;
                document.getElementById('testBannerDetails').textContent = selectedLevel + ' ‚Ä¢ Variant ' + selectedVariant;
            } else {
                document.getElementById('currentLessonBanner').style.display = 'none';
                document.getElementById('testLessonBanner').style.display = 'none';
            }
        }

        function clearCurrentLesson() { currentLesson = null; document.getElementById('currentLessonBanner').style.display = 'none'; }
        
        function renderLessonsList() {
            const sorted = [...lessons].sort((a,b) => {
                const dateA = a.dateTime ? new Date(a.dateTime) : new Date(0);
                const dateB = b.dateTime ? new Date(b.dateTime) : new Date(0);
                return dateB - dateA;
            });
            document.getElementById('lessonsList').innerHTML = sorted.length === 0
                ? '<div class="empty-state"><div class="icon">üìÖ</div><p>No lessons yet. Create one or import from calendar!</p></div>'
                : sorted.map(l => `<div class="lesson-card ${l.status}"><div><div style="font-size:18px;font-weight:600;color:#1e293b">${escapeHtml(l.studentName)||'Unnamed'}</div><div style="color:#64748b;margin-top:4px">${formatDateTime(l.dateTime)} ‚Ä¢ ${l.level||'TBD'}${l.phone ? ' ‚Ä¢ üìû '+escapeHtml(l.phone) : ''}</div>${l.notes?'<div style="color:#94a3b8;margin-top:4px;font-size:14px">'+escapeHtml(l.notes)+'</div>':''}<span style="display:inline-block;margin-top:8px;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;background:${l.status==='completed'?'#dcfce7':l.status==='cancelled'?'#fee2e2':'#dbeafe'};color:${l.status==='completed'?'#166534':l.status==='cancelled'?'#dc2626':'#1d4ed8'}">${l.status||'scheduled'}</span></div><div class="lesson-actions">${l.status==='scheduled'?'<button class="btn btn-primary" onclick="startLessonAssessment(\''+l.id+'\')">Start</button>':''}<button class="btn btn-danger" onclick="deleteLesson('${l.id}')">Delete</button></div></div>`).join('');
        }

        // ============================================
        // HISTORY & DATABASE SAVE
        // ============================================
        function renderHistoryList() {
            document.getElementById('historyList').innerHTML = assessmentHistory.length === 0
                ? '<div class="empty-state" style="background:white;border-radius:16px;padding:60px"><div class="icon">üìä</div><p>No assessments yet</p></div>'
                : assessmentHistory.map(a => {
                    const dateStr = a.date?.toDate ? formatDateTime(a.date.toDate()) : formatDateTime(a.date);
                    const canExport = a.exportExpiry && new Date(a.exportExpiry) > new Date();
                    const exportExpiryStr = a.exportExpiry ? new Date(a.exportExpiry).toLocaleString() : '';
                    return `<div style="background:white;border-radius:16px;padding:24px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08)"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div style="font-size:20px;font-weight:600;color:#1e293b">${escapeHtml(a.studentName)}</div><div style="color:#64748b;margin-top:4px">${a.level} (V${a.variant}) ‚Ä¢ ${dateStr}</div>${a.sessionDuration ? '<div style="color:#f59e0b;margin-top:4px;font-size:14px">‚è±Ô∏è Session: '+a.sessionDuration+'</div>' : ''}</div><div style="text-align:right"><div style="font-size:32px;font-weight:700;color:${a.percentage>=80?'#10b981':a.percentage>=60?'#f59e0b':'#ef4444'}">${a.percentage}%</div><div style="color:#64748b;font-size:14px">${a.totalScore}/${a.maxScore}</div></div></div><div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap">${Object.entries(a.scores||{}).map(([s,d])=>'<div style="padding:8px 16px;background:'+(d.percentage>=60?'#dcfce7':'#fef3c7')+';border-radius:20px;font-size:14px">'+s+': '+d.score+'/'+d.total+'</div>').join('')}</div>${a.recommendations?.length?'<div style="margin-top:16px;padding:12px;background:#fef3c7;border-radius:8px"><div style="font-weight:600;color:#92400e;margin-bottom:8px">Recommendations:</div>'+a.recommendations.map(r=>'<div style="color:#92400e;font-size:14px">‚Ä¢ '+r+'</div>').join('')+'</div>':''}<div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap">${canExport ? '<button class="btn btn-primary" onclick="exportHistoryToWord(\''+a.id+'\')" style="background:#7c4dff">üì• Export to Word</button><span style="color:#64748b;font-size:12px;align-self:center">Expires: '+exportExpiryStr+'</span>' : '<span style="color:#94a3b8;font-size:14px">üì• Export expired (24h limit)</span>'}<button class="btn btn-danger" onclick="deleteAssessment('${a.id}')">Delete</button></div></div>`;
                }).join('');
        }

        async function deleteAssessment(id) { 
            if(confirm('Delete this assessment?')) { 
                const success = await deleteAssessmentFromFirebase(id);
                if (success) {
                    showNotification('Assessment deleted');
                }
            } 
        }
        
        async function clearAllHistory() {
            if (!confirm('Are you sure you want to delete ALL assessment history? This cannot be undone!')) return;
            if (!confirm('This will permanently delete ' + assessmentHistory.length + ' assessments. Are you REALLY sure?')) return;
            
            showNotification('Deleting all history...', 'success');
            let count = 0;
            
            for (const assessment of assessmentHistory) {
                const success = await deleteAssessmentFromFirebase(assessment.id);
                if (success) count++;
            }
            
            showNotification(`Deleted ${count} assessments from cloud`);
        }
        
        async function clearAllLessons() {
            if (!confirm('Are you sure you want to delete ALL lessons? This cannot be undone!')) return;
            if (!confirm('This will permanently delete ' + lessons.length + ' lessons. Are you REALLY sure?')) return;
            
            showNotification('Deleting all lessons...', 'success');
            let count = 0;
            
            for (const lesson of lessons) {
                const success = await deleteLessonFromFirebase(lesson.id);
                if (success) count++;
            }
            
            showNotification(`Deleted ${count} lessons from cloud`);
        }
        
        async function saveResultToDatabase() {
            const name = document.getElementById('studentName').value.trim() || (currentLesson ? currentLesson.studentName : 'Unknown');
            const notes = document.getElementById('testDescription').value.trim();
            const results = calculateAllResults();
            const sessionDuration = getSessionDuration();
            
            // Stop the timer when saving
            stopSessionTimer();
            
            const assessmentData = {
                lessonId: currentLesson?.id || null,
                studentName: name,
                level: selectedLevel,
                variant: selectedVariant,
                scores: results.sectionScores,
                totalScore: results.totalScore,
                maxScore: results.maxScore,
                percentage: results.percentage,
                recommendations: results.recommendations,
                sessionDuration: sessionDuration,
                notes,
                // Store answers for Word export (expires after 24h)
                answersData: JSON.stringify(answers),
                exportExpiry: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
            };

            showNotification('Saving to cloud...', 'success');
            const docId = await addAssessmentToFirebase(assessmentData);
            
            if (docId && currentLesson) {
                await updateLessonInFirebase(currentLesson.id, { 
                    status: 'completed', 
                    assessmentId: docId 
                });
            }
            
            if (docId) {
                showNotification('Assessment saved to cloud! ‚òÅÔ∏è');
            }
        }

        function calculateAllResults() {
            let total = 0, max = 0;
            const sectionScores = {};
            const recs = [];
            ['Listening', 'Reading', 'Grammar'].forEach(section => {
                const result = calculateSectionScore(section);
                sectionScores[section] = { score: result.score, total: result.total, percentage: result.percentage };
                total += result.score;
                max += result.total;
                if (result.percentage < 60) recs.push('Focus on ' + section + ' (' + result.percentage + '%)');
            });
            return { sectionScores, totalScore: total, maxScore: max, percentage: max > 0 ? Math.round((total/max)*100) : 0, recommendations: recs };
        }

        // ============================================
        // UTILITIES
        // ============================================
        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function formatDate(d) { if (!d) return 'TBD'; try { return new Date(d).toLocaleDateString(); } catch(e) { return 'TBD'; } }
        function formatDateTime(d) { if (!d) return 'TBD'; try { return new Date(d).toLocaleString(); } catch(e) { return 'TBD'; } }

        // ============================================
        // TEST DATA
        // ============================================
        const testData = {
            A0: {
                Listening: {
                    variants: {
                        1: {
                            // Variant 1: Jess, David, Tony - Favourite Rooms
                            videoUrl: 'https://drive.google.com/file/d/1jMDfH20kiqxCum768AATUtyITKgmBkfX/preview',
                            description: 'Listen to Jess, David, and Tony describing their favourite rooms',
                            questions: [
                                { q: 'What is Jess\'s favourite room?', type: 'mcq', options: ['The kitchen', 'The bedroom', 'The living room', 'The dining room'], correct: 1 },
                                { q: 'Jess\'s room is big and noisy.', type: 'tf', correct: false },
                                { q: 'What does Jess do at the desk every evening?', type: 'mcq', options: ['Watch TV', 'Play games', 'Study', 'Eat dinner'], correct: 2 },
                                { q: 'David\'s favourite room is the dining room.', type: 'tf', correct: true },
                                { q: 'How many chairs are in David\'s dining room?', type: 'mcq', options: ['Four', 'Five', 'Six', 'Eight'], correct: 2 },
                                { q: 'Where is David\'s old lamp from?', type: 'mcq', options: ['China', 'Japan', 'Turkey', 'France'], correct: 1 },
                                { q: 'David has a rug from Turkey on the floor.', type: 'tf', correct: true },
                                { q: 'How many rooms does Tony\'s apartment have?', type: 'mcq', options: ['One', 'Two', 'Three', 'Four'], correct: 0 },
                                { q: 'Where does Tony eat his meals?', type: 'mcq', options: ['At a table', 'On the bed', 'On the sofa', 'In the kitchen'], correct: 2 },
                                { q: 'Tony\'s room is on the ground floor.', type: 'tf', correct: false },
                                { q: 'What do Tony\'s friends like to do when they visit?', type: 'mcq', options: ['Watch movies', 'Play games', 'Cook food', 'Listen to music'], correct: 3 }
                            ]
                        },
                        2: {
                            // Variant 2: Marco & Lucia - Weekend in London
                            videoUrl: 'https://drive.google.com/file/d/1XH599NiuSQrQcuwV-7hwlvaNSzi5nGM8/preview',
                            description: 'Listen to Marco and Lucia talking about Lucia\'s weekend in London',
                            questions: [
                                { q: 'Where did Lucia go for the weekend?', type: 'mcq', options: ['Paris', 'London', 'Rome', 'Madrid'], correct: 1 },
                                { q: 'Lucia went to the carnival.', type: 'tf', correct: false },
                                { q: 'What show did Lucia see at the theatre?', type: 'mcq', options: ['Cats', 'Wicked', 'The Lion King', 'Mamma Mia'], correct: 2 },
                                { q: 'Lucia loved the songs in the show.', type: 'tf', correct: true },
                                { q: 'What did Lucia eat for dinner?', type: 'mcq', options: ['Pizza', 'Fish and chips', 'Pasta', 'Burger'], correct: 1 },
                                { q: 'Where was the restaurant?', type: 'mcq', options: ['In the city center', 'Next to the river', 'Near the theatre', 'At the hotel'], correct: 1 },
                                { q: 'What did Lucia and her boyfriend do on the boat?', type: 'mcq', options: ['Had dinner', 'Watched a movie', 'Danced', 'Slept'], correct: 2 },
                                { q: 'Lucia stayed at a hotel in London.', type: 'tf', correct: true },
                                { q: 'What did Lucia buy at the market?', type: 'mcq', options: ['A blue dress', 'A red jacket', 'Brown boots', 'A green scarf'], correct: 1 },
                                { q: 'Lucia\'s boots were a present from her dad.', type: 'tf', correct: true },
                                { q: 'What did Lucia have for lunch at the market?', type: 'mcq', options: ['Italian food', 'Chinese food', 'African food', 'Mexican food'], correct: 2 }
                            ]
                        },
                        3: {
                            // Variant 3: Lena, Paul, Holly - Transportation
                            videoUrl: 'https://drive.google.com/file/d/1UfcEVg2wGuE7BxmXFpwN6pfm-w3_hgCr/preview',
                            description: 'Listen to Lena, Paul, and Holly talking about how they travel',
                            questions: [
                                { q: 'Where does Lena live?', type: 'mcq', options: ['In the suburbs', 'In the city center', 'In a small town', 'In the countryside'], correct: 1 },
                                { q: 'How does Lena get to work?', type: 'mcq', options: ['By bus', 'By car', 'She walks', 'By subway'], correct: 2 },
                                { q: 'Lena often uses the bus.', type: 'tf', correct: false },
                                { q: 'How does Lena travel to other cities?', type: 'mcq', options: ['By car', 'By bus', 'By train', 'By plane'], correct: 2 },
                                { q: 'How far is Paul\'s work from his home?', type: 'mcq', options: ['5 miles', '10 miles', '15 miles', '20 miles'], correct: 1 },
                                { q: 'Paul goes to work on his scooter.', type: 'tf', correct: true },
                                { q: 'Why does Paul take the train for a night out?', type: 'mcq', options: ['It\'s cheaper', 'So he can drink', 'It\'s faster', 'He likes trains'], correct: 1 },
                                { q: 'How does Holly get to college?', type: 'mcq', options: ['By bus', 'By car', 'By bike', 'She walks'], correct: 2 },
                                { q: 'Why does Holly take the bus to the supermarket?', type: 'mcq', options: ['It\'s faster', 'She doesn\'t have a bike', 'So she doesn\'t carry heavy bags', 'It\'s cheaper'], correct: 2 },
                                { q: 'Holly can drive a car.', type: 'tf', correct: false },
                                { q: 'Holly never takes taxis because they are too expensive.', type: 'tf', correct: true }
                            ]
                        },
                        4: {
                            // Variant 4: Sophie - Trip to Egypt
                            videoUrl: 'https://drive.google.com/file/d/1_bpjVz44vt4g56LvBKmhgumhDd3LRwIV/preview',
                            description: 'Listen to Sophie talking about her trip to Egypt',
                            questions: [
                                { q: 'Where did Sophie go on holiday?', type: 'mcq', options: ['Turkey', 'Greece', 'Egypt', 'Morocco'], correct: 2 },
                                { q: 'Sophie usually goes on holiday in Britain.', type: 'tf', correct: true },
                                { q: 'Did Sophie travel with a friend?', type: 'mcq', options: ['Yes, with her best friend', 'Yes, with her sister', 'No, she went alone', 'Yes, with her boyfriend'], correct: 2 },
                                { q: 'Where did Sophie stay?', type: 'mcq', options: ['In expensive hotels', 'In guest houses', 'With friends', 'In a tent'], correct: 1 },
                                { q: 'Sophie thought the guest houses were nicer than hotels.', type: 'tf', correct: true },
                                { q: 'What did Sophie eat on the first night?', type: 'mcq', options: ['Local food from the market', 'Food at a European restaurant', 'Food at the guest house', 'Fast food'], correct: 1 },
                                { q: 'Sophie got sick during her trip.', type: 'tf', correct: true },
                                { q: 'How long was Sophie sick?', type: 'mcq', options: ['A few hours', 'One day', 'Three days', 'A week'], correct: 1 },
                                { q: 'What did Sophie enjoy most?', type: 'mcq', options: ['The historic sites', 'The local food', 'Boat trips on the River Nile', 'Shopping at markets'], correct: 2 },
                                { q: 'The historic sites were very quiet.', type: 'tf', correct: false },
                                { q: 'Sophie liked the sunsets on the river.', type: 'tf', correct: true }
                            ]
                        }
                    }
                },
                Reading: {
                    text: 'My name is Tom. I am 25 years old. I live in a small house with my cat. My cat is black and white. Her name is Lily. Every day, I wake up at 7 AM. I eat breakfast with Lily. Then I go to work. I work in a school. I teach children. I love my job. After work, I come home and play with Lily. We are very happy.',
                    questions: [
                        { q: 'Tom is 25 years old.', type: 'tf', correct: true },
                        { q: 'What color is the cat?', type: 'mcq', options: ['All black', 'Black and white', 'Brown', 'White'], correct: 1 },
                        { q: "Complete the sentence: The cat's name is ___", type: 'sentence', stem: "The cat's name is", answer: 'Lily' },
                        { q: 'Tom teaches adults.', type: 'tf', correct: false },
                        { q: 'What time does Tom wake up?', type: 'short', correct: '7' },
                        { q: 'Match: Tom works in a ___', type: 'sentence', stem: 'Tom works in a', answer: 'school' }
                    ]
                },
                Writing: {
                    task1: 'Translate to English: –ú–µ–Ω—è –∑–æ–≤—É—Ç [your name]. –ú–Ω–µ [age] –ª–µ—Ç. –Ø –∂–∏–≤—É –≤ [city].',
                    task2: 'Write 3-5 sentences about your family.',                },
                Speaking: {
                    part1: ['What is your name?', 'Where do you live?', 'Do you have pets?', 'What is your favorite color?'],
                    part2: 'Describe your best friend. You should say: their name, how you met, what they look like, and why you like them.',
                    instruction: 'Prepare your answers mentally or record yourself speaking. This helps evaluate your speaking fluency.'
                },
                Grammar: [
                    { q: 'I ___ a student.', type: 'mcq', options: ['am', 'is', 'are', 'be'], correct: 0, topic: 'Verb To Be - Present Simple' },
                    { q: 'She ___ to school every day.', type: 'mcq', options: ['go', 'goes', 'going', 'went'], correct: 1, topic: 'Present Simple - Third Person' },
                    { q: 'Translate: –Ø –ª—é–±–ª—é —á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥–∏.', type: 'short', correct: 'I love reading books', topic: 'Basic Translation' },
                    { q: 'They ___ playing football.', type: 'mcq', options: ['is', 'am', 'are', 'be'], correct: 2, topic: 'Verb To Be - Plural' },
                    { q: 'Choose the correct: Yesterday I ___ to the park.', type: 'mcq', options: ['go', 'goes', 'went', 'going'], correct: 2, topic: 'Past Simple' },
                    { q: 'My brother ___ tall.', type: 'mcq', options: ['am', 'is', 'are', 'be'], correct: 1, topic: 'Verb To Be - Singular' },
                    { q: 'Complete: I ___ a dog.', type: 'sentence', stem: 'I', answer: 'have', topic: 'Verb Have' },
                    { q: 'We ___ English every day.', type: 'mcq', options: ['study', 'studies', 'studying', 'studied'], correct: 0, topic: 'Present Simple' },
                    { q: '___ you like pizza?', type: 'mcq', options: ['Do', 'Does', 'Is', 'Are'], correct: 0, topic: 'Questions - Present Simple' },
                    { q: 'She ___ watching TV now.', type: 'mcq', options: ['am', 'is', 'are', 'be'], correct: 1, topic: 'Present Continuous' }
                ]
            },
            'B1/B2': {
                Listening: {
                    variants: {
                        1: {
                            // Variant 1: Money Management - Joseph, Taylor, Dina, Liam, Ben, Sophie
                            videoUrl: 'https://drive.google.com/file/d/1QL5mDv49MDnOYqZeNzGcd_-gZm1EDxi2/preview',
                            description: 'Listen to six people talking about money and financial situations',
                            questions: [
                                // Joseph
                                { q: 'What is Joseph saving money for?', type: 'mcq', options: ['A car', 'A bike', 'A house', 'A holiday'], correct: 1 },
                                { q: 'Joseph works as a waiter.', type: 'tf', correct: true },
                                { q: 'Joseph wants to take a loan to buy his bike.', type: 'tf', correct: false },
                                // Taylor
                                { q: 'How does Taylor pay for things nowadays?', type: 'mcq', options: ['Cash only', 'Cheques', 'Cards exclusively', 'A mix of cash and cards'], correct: 2 },
                                { q: 'According to Taylor, even street performers in London have card readers.', type: 'tf', correct: true },
                                // Dina
                                { q: 'Why couldn\'t Dina\'s friend afford her rent?', type: 'mcq', options: ['She lost her job', 'She had medical expenses', 'She bought a car', 'She went on holiday'], correct: 1 },
                                { q: 'Dina let her friend get a bank loan.', type: 'tf', correct: false },
                                // Liam
                                { q: 'What takes up a big part of Liam\'s salary?', type: 'mcq', options: ['Car payments', 'Mortgage payments', 'Student loans', 'Credit card debt'], correct: 1 },
                                { q: 'Liam often goes out for dinner with friends.', type: 'tf', correct: false },
                                // Ben
                                { q: 'What did Ben have to pay for unexpectedly?', type: 'mcq', options: ['Medical bills', 'Car repair', 'Home repair', 'Legal fees'], correct: 1 },
                                { q: 'Ben paid for the repair with his savings.', type: 'tf', correct: false },
                                // Sophie
                                { q: 'What happened when Sophie\'s cousin asked for more money?', type: 'mcq', options: ['Sophie gave it to her', 'Sophie said no', 'Sophie asked for interest', 'Sophie ignored her'], correct: 1 },
                                { q: 'Sophie thinks mixing money with family is a good idea.', type: 'tf', correct: false }
                            ]
                        },
                        2: {
                            // Variant 2: How Do You Travel to Work? - Piers, Sydney, Brenda, Nick
                            videoUrl: 'https://drive.google.com/file/d/1nv7Z9E-AK7BxcJ-vU013dJOFwkMlT1DC/preview',
                            description: 'Listen to four people describing how they travel to work',
                            questions: [
                                // Piers
                                { q: 'How does Piers start his journey to work?', type: 'mcq', options: ['By car', 'By bus', 'By train', 'By bike'], correct: 1 },
                                { q: 'Piers can usually find a seat on the bus.', type: 'tf', correct: false },
                                { q: 'What does Piers do before getting on the tube?', type: 'mcq', options: ['Reads a book', 'Grabs a coffee', 'Makes phone calls', 'Exercises'], correct: 1 },
                                { q: 'Piers thinks the underground feels warm and personal.', type: 'tf', correct: false },
                                // Sydney
                                { q: 'What does Sydney drive to work?', type: 'mcq', options: ['A car', 'A van', 'A motorcycle', 'A truck'], correct: 1 },
                                { q: 'How long is Sydney\'s journey to work?', type: 'mcq', options: ['15 minutes', '25 minutes', '35 minutes', '45 minutes'], correct: 2 },
                                { q: 'Sydney sometimes slows down to make the drive last longer.', type: 'tf', correct: true },
                                // Brenda
                                { q: 'Where does Brenda live?', type: 'mcq', options: ['London', 'New York', 'Amsterdam', 'Paris'], correct: 2 },
                                { q: 'What transport does Brenda use daily?', type: 'mcq', options: ['Car and train', 'Bicycle and ferry', 'Bus and tram', 'Motorcycle and boat'], correct: 1 },
                                { q: 'Brenda found cycling in New York peaceful and safe.', type: 'tf', correct: false },
                                // Nick
                                { q: 'How long is Nick\'s commute each way?', type: 'mcq', options: ['30 minutes', '45 minutes', 'Over an hour', '2 hours'], correct: 2 },
                                { q: 'What does Nick do during his commute now?', type: 'mcq', options: ['Sleeps', 'Listens to podcasts and audiobooks', 'Works on his laptop', 'Watches movies'], correct: 1 },
                                { q: 'Nick is learning French during his commute.', type: 'tf', correct: true }
                            ]
                        },
                        3: {
                            // Variant 3: Living with Your Ex After a Break-up - Maria
                            videoUrl: 'https://drive.google.com/file/d/17PdGGXU7TimjjkQKV_TYdEfO4gkf_gtn/preview',
                            description: 'Listen to Maria talking about living with her ex-boyfriend after their break-up',
                            questions: [
                                { q: 'Who decided to end the relationship?', type: 'mcq', options: ['Adam', 'Maria', 'Both of them', 'Their friends'], correct: 1 },
                                { q: 'Why couldn\'t Maria move out immediately?', type: 'mcq', options: ['She didn\'t want to', 'They couldn\'t afford it', 'Adam asked her to stay', 'The landlord refused'], correct: 1 },
                                { q: 'Where did Maria move to within the apartment?', type: 'mcq', options: ['The living room', 'The guest bedroom', 'A storage room', 'The kitchen'], correct: 2 },
                                { q: 'Maria had very few clothes so storage was easy.', type: 'tf', correct: false },
                                { q: 'What did Maria do after having a rough day at school?', type: 'mcq', options: ['Called her mother', 'Turned to Adam for comfort', 'Went out with friends', 'Stayed in her room'], correct: 1 },
                                { q: 'Maria and Adam agreed not to date anyone else while living together.', type: 'tf', correct: true },
                                { q: 'How did Adam find out about Maria\'s new romantic interest?', type: 'mcq', options: ['Maria told him directly', 'He read her messages', 'He overheard her conversation', 'A friend told him'], correct: 2 },
                                { q: 'What did Adam do after finding out about the other guy?', type: 'mcq', options: ['He cried', 'He moved out', 'He brought a girl home', 'He forgave Maria'], correct: 2 },
                                { q: 'How long did Maria stay in the apartment?', type: 'mcq', options: ['Three months', 'Six months', 'One year', 'Two years'], correct: 1 },
                                { q: 'Maria\'s friendship with Sarah remained strong after she moved out.', type: 'tf', correct: false },
                                { q: 'Maria believes she should have moved out sooner.', type: 'tf', correct: true }
                            ]
                        },
                        4: {
                            // Variant 4: Albert Einstein Biography
                            videoUrl: 'https://drive.google.com/file/d/1DtlezkmsTeQuC-uSKkuC46h8e5DnaTUL/preview',
                            description: 'Listen to a biography of Albert Einstein',
                            questions: [
                                { q: 'Where was Albert Einstein born?', type: 'mcq', options: ['Munich, Germany', 'Ulm, Germany', 'Bern, Switzerland', 'Milan, Italy'], correct: 1 },
                                { q: 'Einstein easily found academic employment after graduating.', type: 'tf', correct: false },
                                { q: 'What job did Einstein have in 1902?', type: 'mcq', options: ['Professor', 'Patent clerk', 'Researcher', 'Teacher'], correct: 1 },
                                { q: 'Which year is called Einstein\'s "miracle year"?', type: 'mcq', options: ['1902', '1905', '1915', '1921'], correct: 1 },
                                { q: 'Who experimentally confirmed general relativity in 1919?', type: 'mcq', options: ['Max Planck', 'Niels Bohr', 'Sir Arthur Eddington', 'Werner Heisenberg'], correct: 2 },
                                { q: 'Einstein won the Nobel Prize for his work on relativity.', type: 'tf', correct: false },
                                { q: 'Why did Einstein leave Germany in 1933?', type: 'mcq', options: ['For a better job', 'He was driven out by the Nazis', 'His wife wanted to move', 'For health reasons'], correct: 1 },
                                { q: 'Einstein became a U.S. citizen in 1940.', type: 'tf', correct: true },
                                { q: 'What position was Einstein offered but turned down?', type: 'mcq', options: ['Director of NASA', 'President of Israel', 'Head of the UN', 'Prime Minister of Germany'], correct: 1 },
                                { q: 'What did Einstein famously do when confronted by paparazzi?', type: 'mcq', options: ['Ran away', 'Covered his face', 'Stuck out his tongue', 'Smiled politely'], correct: 2 },
                                { q: 'According to the passage, Einstein\'s work has no impact on modern technology.', type: 'tf', correct: false }
                            ]
                        }
                    }
                },
                Reading: {
                    text: 'Climate change represents one of the most significant challenges facing humanity today. Rising global temperatures have led to melting ice caps, rising sea levels, and increasingly frequent extreme weather events. Scientists warn that without immediate action, the consequences could be catastrophic. However, there is still hope. Many countries are transitioning to renewable energy sources, and individuals are making more environmentally conscious decisions. The question is not whether we can make a difference, but whether we will act quickly enough to prevent the worst outcomes.',
                    questions: [
                        { q: 'What is the main idea of this passage?', type: 'mcq', options: ['Climate change is unsolvable', 'Climate change requires urgent action', 'Climate change is not real', 'Climate change only affects animals'], correct: 1 },
                        { q: 'Match the information: Rising temperatures cause ___', type: 'match', pairs: [['melting ice', 'polar regions'], ['sea level rise', 'coastal areas'], ['extreme weather', 'global impact']], correctPairs: [['melting ice', 'polar regions'], ['sea level rise', 'coastal areas']] },
                        { q: 'The author believes the situation is hopeless.', type: 'tf', correct: false },
                        { q: 'Complete: Many countries are transitioning to ___ energy sources.', type: 'sentence', stem: 'Many countries are transitioning to', answer: 'renewable' },
                        { q: 'According to the writer, what is the key question?', type: 'short', correct: 'whether we will act quickly enough' },
                        { q: 'What claim does the author make about individuals?', type: 'views', statement: 'Individuals are making environmentally conscious decisions', answer: 'yes' }
                    ]
                },
                Writing: {
                    variants: {
                        1: {
                            task1: 'The diagram below shows how rainwater is collected for the use of drinking water in an Australian town. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.',
                            task2: 'Write an essay plan (introduction, 2 body paragraphs, conclusion) for: "Some people believe technology makes us less social. To what extent do you agree or disagree?"',
                            chartUrl: 'https://drive.google.com/thumbnail?id=1LJRKA69IaURz9NjuUC1on0jn2By3KTxD&sz=w800'
                        },
                        2: {
                            task1: 'The table below gives information about the employment sectors in which people from 3 age groups worked. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.',
                            task2: 'Write an essay plan (introduction, 2 body paragraphs, conclusion) for: "In many countries, young people are choosing to work abroad rather than in their home country. What are the advantages and disadvantages of this trend?"',
                            chartUrl: 'https://drive.google.com/thumbnail?id=1w5j2MDRZT7OlGNWmeRQI6Pj2HiIcS_t_&sz=w800'
                        },
                        3: {
                            task1: 'The graph below shows the consumption of three kinds of spreads (margarine, low fat & reduced spreads, and butter) between 1981 and 2007. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.',
                            task2: 'Write an essay plan (introduction, 2 body paragraphs, conclusion) for: "Many people believe that social media has a negative impact on mental health. To what extent do you agree or disagree?"',
                            chartUrl: 'https://drive.google.com/thumbnail?id=18ulG8oe9F095VCkJD-t6NA1hAv6UJXbE&sz=w800'
                        },
                        4: {
                            task1: 'The diagram shows the consumption of renewable energy in the USA from 1949-2008. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.',
                            task2: 'Write an essay plan (introduction, 2 body paragraphs, conclusion) for: "Some people think that governments should invest more in public transportation. Others believe the money should be spent on building more roads. Discuss both views and give your opinion."',
                            chartUrl: 'https://drive.google.com/thumbnail?id=1-KGaAh7WYEp2dsFjMolXtG-epACmKloM&sz=w800'
                        }
                    }
                },
                Speaking: {
                    part1: ['What do you do in your free time?', 'Do you prefer city or countryside living? Why?', 'How important is education in your country?', 'What are your career goals?'],
                    part2: 'Describe a memorable journey you have taken. You should say: where you went, who you went with, what you did there, and why it was memorable.',
                    instruction: 'Practice speaking your answers aloud. Time yourself: Part 1 (4-5 min), Part 2 (2 min speaking + 1 min prep)'
                },
                Grammar: [
                    { q: 'If I ___ more time, I would travel the world.', type: 'mcq', options: ['have', 'had', 'has', 'having'], correct: 1, topic: 'Second Conditional' },
                    { q: 'The report ___ by the manager yesterday.', type: 'mcq', options: ['writes', 'wrote', 'was written', 'has written'], correct: 2, topic: 'Passive Voice - Past Simple' },
                    { q: 'She has been working here ___ 2015.', type: 'mcq', options: ['for', 'since', 'from', 'at'], correct: 1, topic: 'Present Perfect Continuous - Time Prepositions' },
                    { q: 'I wish I ___ speak French.', type: 'mcq', options: ['can', 'could', 'will', 'would'], correct: 1, topic: 'Wish + Past Simple' },
                    { q: 'By next year, they ___ the project.', type: 'mcq', options: ['complete', 'completed', 'will have completed', 'are completing'], correct: 2, topic: 'Future Perfect' },
                    { q: 'Complete: If I had known, I ___ you.', type: 'sentence', stem: 'If I had known, I', answer: 'would have told', topic: 'Third Conditional' },
                    { q: 'Neither of the students ___ finished the test.', type: 'mcq', options: ['have', 'has', 'are', 'is'], correct: 1, topic: 'Subject-Verb Agreement - Neither' },
                    { q: 'She suggested ___ to the cinema.', type: 'mcq', options: ['go', 'to go', 'going', 'gone'], correct: 2, topic: 'Gerunds after Suggest' },
                    { q: 'The book, ___ I bought yesterday, is fascinating.', type: 'mcq', options: ['who', 'which', 'where', 'when'], correct: 1, topic: 'Relative Clauses - Which' },
                    { q: '___ the difficulties, they succeeded.', type: 'mcq', options: ['Despite', 'Although', 'Because', 'If'], correct: 0, topic: 'Contrast - Despite vs Although' },
                    { q: 'Translate: –ï—Å–ª–∏ –±—ã —è –∑–Ω–∞–ª –æ—Ç–≤–µ—Ç, —è –±—ã —Ç–µ–±–µ —Å–∫–∞–∑–∞–ª.', type: 'short', correct: 'If I had known the answer, I would have told you', topic: 'Third Conditional Translation' }
                ]
            },
            IELTS: {
                Listening: {
                    variants: {
                        1: {
                            // Variant 1: The Benefits of a Bilingual Brain
                            videoUrl: 'https://drive.google.com/file/d/1nwa9Ma3qbUHRZNmh2UyRemGYMcOg4hOC/preview',
                            description: 'Listen to a talk about how bilingualism affects the brain',
                            questions: [
                                { q: 'According to the video, most people in the world are:', type: 'mcq', options: ['Monolingual', 'Bilingual or multilingual', 'Trilingual', 'Language learners'], correct: 1 },
                                { q: 'Language ability is measured in how many skills?', type: 'mcq', options: ['Two', 'Three', 'Four', 'Five'], correct: 2 },
                                { q: 'A balanced bilingual has equal abilities in all skills in two languages.', type: 'tf', correct: true },
                                { q: 'What type of bilingual is Gabriella (who immigrated at age 2)?', type: 'mcq', options: ['Coordinate bilingual', 'Compound bilingual', 'Subordinate bilingual', 'Sequential bilingual'], correct: 1 },
                                { q: 'Subordinate bilinguals learn a second language by filtering it through their primary language.', type: 'tf', correct: true },
                                { q: 'Which brain hemisphere is typically more dominant in logical processes?', type: 'mcq', options: ['Right hemisphere', 'Left hemisphere', 'Both equally', 'Neither'], correct: 1 },
                                { q: 'According to the critical period hypothesis, children learn languages more easily because:', type: 'mcq', options: ['They have more free time', 'Their brains are more plastic', 'They are more motivated', 'They have better teachers'], correct: 1 },
                                { q: 'Research shows that adult second-language learners often exhibit less emotional bias when problem-solving in their second language.', type: 'tf', correct: true },
                                { q: 'What physically visible advantage do bilingual brains have?', type: 'mcq', options: ['Larger brain size', 'Higher density of gray matter', 'More blood vessels', 'Thicker skull'], correct: 1 },
                                { q: 'Bilingualism can delay Alzheimer\'s and dementia by how many years?', type: 'mcq', options: ['Two years', 'Three years', 'Five years', 'Ten years'], correct: 2 },
                                { q: 'Before the 1960s, bilingualism was considered an advantage for child development.', type: 'tf', correct: false },
                                { q: 'Which brain region is strengthened by switching between languages?', type: 'mcq', options: ['Hippocampus', 'Cerebellum', 'Dorsolateral prefrontal cortex', 'Amygdala'], correct: 2 },
                                { q: 'The dorsolateral prefrontal cortex plays a key role in:', type: 'mcq', options: ['Memory storage', 'Executive function and problem-solving', 'Emotional responses', 'Motor control'], correct: 1 },
                                { q: 'According to the video, bilingualism definitely makes you smarter.', type: 'tf', correct: false }
                            ]
                        },
                        2: {
                            // Variant 2: North Korea - South Korea Tensions (News Report)
                            videoUrl: 'https://drive.google.com/file/d/1BuVKY3KmAyLjgYHPLQvEVZMz3op329FL/preview',
                            description: 'Listen to a news report about tensions between North and South Korea',
                            questions: [
                                { q: 'What are protesters in South Korea calling for?', type: 'mcq', options: ['Peace talks', 'UN and international community to punish North Korea', 'Removal of US troops', 'New elections'], correct: 1 },
                                { q: 'What triggered the escalation of tensions between the two Koreas?', type: 'mcq', options: ['A missile launch', 'Anti-North Korean propaganda broadcasts', 'A naval attack', 'A cyber attack'], correct: 1 },
                                { q: 'What happened in the demilitarized zone that Seoul blames Pyongyang for?', type: 'mcq', options: ['A shooting', 'A bombing', 'A landmine explosion', 'A kidnapping'], correct: 2 },
                                { q: 'Two South Korean border guards were killed in the incident.', type: 'tf', correct: false },
                                { q: 'Kim Jong-un called the loudspeaker broadcasts:', type: 'mcq', options: ['An act of war', 'Psychological warfare', 'A minor annoyance', 'Illegal activity'], correct: 1 },
                                { q: 'How long did Kim give South Korea to shut down the loudspeakers?', type: 'mcq', options: ['24 hours', '48 hours', '72 hours', 'One week'], correct: 1 },
                                { q: 'Kim Jong-un is known for making empty, theatrical threats.', type: 'tf', correct: true },
                                { q: 'What have the two sides already exchanged?', type: 'mcq', options: ['Missiles', 'Warning shots', 'Prisoners', 'Diplomats'], correct: 1 },
                                { q: 'Where have residents near the border been forced to go?', type: 'mcq', options: ['To hospitals', 'To other cities', 'Into shelters', 'Across the border'], correct: 2 },
                                { q: 'What has South Korea\'s president ordered troops to do if attacked?', type: 'mcq', options: ['Retreat', 'Call for help', 'Retaliate', 'Surrender'], correct: 2 },
                                { q: 'Both the United States and the United Nations have called for calm.', type: 'tf', correct: true },
                                { q: 'What will the U.S. Army continue with the South Korean military?', type: 'mcq', options: ['Peace negotiations', 'Annual training exercises', 'Border patrols', 'Weapon sales'], correct: 1 },
                                { q: 'North Korea supports the presence of US military exercises near its border.', type: 'tf', correct: false },
                                { q: 'Who reported this news story?', type: 'mcq', options: ['CNN', 'BBC', 'CBC News', 'Al Jazeera'], correct: 2 }
                            ]
                        },
                        3: {
                            // Variant 3: Illegal Wildlife Trade in Thailand (News Report)
                            videoUrl: 'https://drive.google.com/file/d/1ewXxr8XktJRFR08Et7VnjeYfqqOJuD9o/preview',
                            description: 'Listen to a news report about illegal wildlife trade in Thailand',
                            questions: [
                                { q: 'What animals were seized that were ready for export?', type: 'mcq', options: ['Tigers', 'Elephants', 'Pangolins', 'Monkeys'], correct: 2 },
                                { q: 'Where were the pangolins likely being sent?', type: 'mcq', options: ['Japan', 'China', 'Vietnam', 'Indonesia'], correct: 1 },
                                { q: 'How many pangolins were seized?', type: 'mcq', options: ['73', '137', '173', '317'], correct: 2 },
                                { q: 'What was the estimated value of the seized pangolins?', type: 'mcq', options: ['$30,000', '$100,000', 'More than $300,000', '$1 million'], correct: 2 },
                                { q: 'The kingpins behind the illegal wildlife trade are frequently caught.', type: 'tf', correct: false },
                                { q: 'Thailand serves as a major hub for illegal wildlife trade in which region?', type: 'mcq', options: ['East Asia', 'Southeast Asia', 'South Asia', 'Central Asia'], correct: 1 },
                                { q: 'What is the name of the market that has become the center of Bangkok\'s illegal wildlife trade?', type: 'mcq', options: ['Chatuchak Market', 'Floating Market', 'Night Market', 'Central Market'], correct: 0 },
                                { q: 'What endangered animal was shown being easily purchased with a hidden camera?', type: 'mcq', options: ['Pangolin', 'Star tortoise', 'Snow leopard', 'Red panda'], correct: 1 },
                                { q: 'Where is the star tortoise mainly found?', type: 'mcq', options: ['China and Japan', 'India and Sri Lanka', 'Thailand and Vietnam', 'Indonesia and Malaysia'], correct: 1 },
                                { q: 'Police conduct regular raids at the market.', type: 'tf', correct: true },
                                { q: 'What problem do police face when patrolling the market too often?', type: 'mcq', options: ['They get tired', 'Traffickers recognize them and hide animals', 'The market closes', 'They run out of funding'], correct: 1 },
                                { q: 'What often happens to offenders under Thai law?', type: 'mcq', options: ['Long prison sentences', 'They escape with a fine', 'Deportation', 'Community service'], correct: 1 },
                                { q: 'How do traffickers often justify selling endangered species?', type: 'mcq', options: ['They have permits', 'They claim the animals were bred in captivity', 'They say they are rescuing them', 'They deny the animals are endangered'], correct: 1 },
                                { q: 'How long ago was a stronger wildlife protection law drafted?', type: 'mcq', options: ['Two years', 'Five years', 'Eight years', 'Ten years'], correct: 2 },
                                { q: 'The stronger wildlife protection law has been passed by Parliament.', type: 'tf', correct: false }
                            ]
                        },
                        4: {
                            // Variant 4: University Accommodation Experiences - Jennie, Ben, Joseph
                            videoUrl: 'https://drive.google.com/file/d/13U2G3BY0Ft6juoRN65nlNt2xHl6Vr_ab/preview',
                            description: 'Listen to three people talking about their university accommodation experiences',
                            questions: [
                                // Jennie
                                { q: 'Who paid for Jennie\'s first year accommodation?', type: 'mcq', options: ['Jennie herself', 'Her parents', 'A scholarship', 'Student loan'], correct: 1 },
                                { q: 'What type of hall was Jennie placed in?', type: 'mcq', options: ['Mixed hall', 'All-male hall', 'All-female hall', 'Postgraduate hall'], correct: 2 },
                                { q: 'Jennie was happy with being placed in an all-female hall.', type: 'tf', correct: false },
                                { q: 'Where was Jennie\'s room located in the building?', type: 'mcq', options: ['Top floor', 'Ground floor', 'Basement level', 'Second floor'], correct: 2 },
                                { q: 'What did Jennie have to take care of herself?', type: 'mcq', options: ['Meals and laundry', 'Only laundry', 'Only meals', 'Nothing'], correct: 1 },
                                { q: 'Jennie was very sociable and made many friends at mealtimes.', type: 'tf', correct: false },
                                // Ben
                                { q: 'How did Ben feel about moving away from home?', type: 'mcq', options: ['Nervous', 'Excited and couldn\'t wait', 'Indifferent', 'Sad'], correct: 1 },
                                { q: 'What was Ben\'s hall of residence next to?', type: 'mcq', options: ['The library', 'The student bar', 'The sports center', 'The main building'], correct: 1 },
                                { q: 'Ben cooked proper meals regularly.', type: 'tf', correct: false },
                                { q: 'What did Ben do when he ran out of clean clothes?', type: 'mcq', options: ['Did laundry', 'Went home to his mum', 'Wore dirty clothes', 'Bought more clothes'], correct: 3 },
                                { q: 'Ben regrets how he lived at university.', type: 'tf', correct: false },
                                // Joseph
                                { q: 'Why did Joseph choose a shared house over halls of residence?', type: 'mcq', options: ['It was cheaper', 'He thought it would be quieter', 'His friends lived there', 'It had better facilities'], correct: 1 },
                                { q: 'How many people lived in Joseph\'s shared house?', type: 'mcq', options: ['Four', 'Five', 'Six', 'Seven'], correct: 2 },
                                { q: 'Joseph got along well with his housemates.', type: 'tf', correct: false },
                                { q: 'What problems did Joseph have with his housemates?', type: 'mcq', options: ['They were too quiet', 'They were noisy, had parties, and smoked', 'They never paid rent', 'They ate his food'], correct: 1 },
                                { q: 'Joseph almost quit his university course because of his accommodation.', type: 'tf', correct: true },
                                { q: 'Where did Joseph end up living for the rest of the year?', type: 'mcq', options: ['Back home with parents', 'In halls of residence', 'Lodging with an elderly woman', 'In a different shared house'], correct: 2 },
                                { q: 'What did Gladys make for Joseph every week?', type: 'mcq', options: ['Dinner', 'A cake', 'Breakfast', 'Sandwiches'], correct: 1 }
                            ]
                        }
                    }
                },
                Reading: {
                    text: 'The phenomenon of urbanization has dramatically reshaped human civilization over the past two centuries. What began as a gradual migration from rural areas to cities during the Industrial Revolution has accelerated into a global trend, with over half of the world\'s population now residing in urban environments. This shift has profound implications for economic development, social structures, and environmental sustainability. Cities serve as engines of innovation and economic growth, concentrating resources, talent, and opportunities in ways that rural areas cannot match. However, rapid urbanization also presents significant challenges, including overcrowding, pollution, inequality, and strain on infrastructure. The success of future urban development will depend on our ability to create sustainable, inclusive cities that balance economic prosperity with social equity and environmental stewardship. Urban planners face the complex task of designing spaces that accommodate growing populations while preserving quality of life. Some experts argue that vertical expansion and green architecture offer viable solutions, while others advocate for decentralized urban networks. The debate continues, but one thing remains clear: the urban century demands innovative thinking and collaborative action.',
                    questions: [
                        { q: 'What is the main theme of this passage?', type: 'mcq', options: ['Rural decline', 'Urban transformation and challenges', 'Industrial history', 'Environmental destruction'], correct: 1 },
                        { q: 'Match information: Urban benefits include ___', type: 'match', pairs: [['Economic', 'innovation hubs'], ['Social', 'diverse opportunities'], ['Infrastructure', 'resource concentration']], correctPairs: [['Economic', 'innovation hubs'], ['Social', 'diverse opportunities']] },
                        { q: 'Identify the writer\'s claim: Cities are exclusively positive for development.', type: 'views', statement: 'Cities are exclusively positive', answer: 'no' },
                        { q: 'Complete: Future success depends on creating ___ cities.', type: 'sentence', stem: 'Future success depends on creating', answer: 'sustainable, inclusive' },
                        { q: 'According to the passage, what percentage of people live in urban areas?', type: 'short', correct: 'over half' },
                        { q: 'The author presents urbanization as entirely negative.', type: 'tf', correct: false },
                        { q: 'Match features: Solutions mentioned include ___', type: 'match', pairs: [['Vertical expansion', 'building upward'], ['Green architecture', 'sustainable design'], ['Decentralized networks', 'distributed cities']], correctPairs: [['Vertical expansion', 'building upward'], ['Green architecture', 'sustainable design']] },
                        { q: 'What does the author suggest about urban planning?', type: 'short', correct: 'requires innovative thinking' }
                    ]
                },
                Writing: {
                    variants: {
                        1: {
                            task1: 'The line and bar charts below show information about visits to and from the UK from 1979 to 1999, and the most popular countries visited by UK residents in 1999. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.',
                            task2: 'Write a complete essay: "In many countries, the gap between rich and poor is widening. What problems does this cause and what solutions can you suggest?" Include: paraphrased thesis, 2 problems with examples, 2 solutions with support, conclusion.',
                            chartUrl: 'https://drive.google.com/thumbnail?id=1u-oUFhn9UQl7s9vPXDu8YhFsl4BTnYkA&sz=w800'
                        },
                        2: {
                            task1: 'The pie and bar charts below show the percentage of persons arrested in the five years ending 1994 and the most recent reasons for arrest. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.',
                            task2: 'Write a complete essay: "Some people believe that criminals should be punished with lengthy prison sentences, while others argue that rehabilitation and community service are more effective. Discuss both views and give your opinion."',
                            chartUrl: 'https://drive.google.com/thumbnail?id=1LcDa2WAuJLysmO3J5RDWrmDveblKWptQ&sz=w800'
                        },
                        3: {
                            task1: 'The pie charts below show information about Public Sector Employment in 2015 and 2020. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.',
                            task2: 'Write a complete essay: "Government spending on public services has increased significantly in recent years. Some people think this is a positive development, while others believe it leads to inefficiency. Discuss both views and give your opinion."',
                            chartUrl: 'https://drive.google.com/thumbnail?id=1x0zCwdyZRh4di7zXGqfD8apbmVtFCpIJ&sz=w800'
                        },
                        4: {
                            task1: 'The maps below show the development of the village of Ryemouth between 1995 and present. Summarise the information by selecting and reporting the main features, and make comparisons where relevant.',
                            task2: 'Write a complete essay: "Many towns and cities are changing rapidly due to urban development. What are the advantages and disadvantages of such changes for local communities?"',
                            chartUrl: 'https://drive.google.com/thumbnail?id=11Mbu_QZIwy2uouCys4j8gMBRifc413aG&sz=w800'
                        }
                    }
                },
                Speaking: {
                    part1: ['How has your hometown changed in recent years?', 'What role does technology play in your daily life?', 'Do you think work-life balance is important? Why?', 'What are your views on lifelong learning?'],
                    part2: 'Describe a person who has influenced your thinking. You should say: who this person is, how you know them, what ideas they have shared, and explain how they have influenced you.',
                    part3: ['How do cultural values shape individual behavior?', 'To what extent should governments regulate personal choices?', 'What are the long-term implications of increasing globalization?', 'How can societies balance tradition with modernization?'],
                    instruction: 'Practice speaking naturally. Part 1 (4-5 min), Part 2 (2 min + 1 min prep), Part 3 (4-5 min discussion)'
                },
                Grammar: [
                    { q: 'Scarcely ___ arrived when the meeting started.', type: 'mcq', options: ['I have', 'have I', 'had I', 'I had'], correct: 2, topic: 'Inversion - Scarcely/Hardly' },
                    { q: 'The committee has requested that the proposal ___ revised.', type: 'mcq', options: ['is', 'be', 'will be', 'would be'], correct: 1, topic: 'Subjunctive Mood' },
                    { q: 'Not only ___ the deadline, but they also exceeded expectations.', type: 'mcq', options: ['they met', 'did they meet', 'they have met', 'have they met'], correct: 1, topic: 'Inversion - Not only' },
                    { q: 'Were it not for your assistance, I ___ the project.', type: 'mcq', options: ['cannot complete', 'could not complete', 'could not have completed', 'cannot have completed'], correct: 2, topic: 'Mixed Conditional with Inversion' },
                    { q: 'The findings, ___ were unexpected, warrant further investigation.', type: 'mcq', options: ['that', 'which', 'who', 'what'], correct: 1, topic: 'Non-defining Relative Clauses' },
                    { q: 'She objected to ___ treated unfairly.', type: 'mcq', options: ['be', 'being', 'been', 'have been'], correct: 1, topic: 'Gerunds after Prepositions' },
                    { q: 'The extent ___ technology affects learning remains debatable.', type: 'mcq', options: ['to which', 'of which', 'in which', 'at which'], correct: 0, topic: 'Relative Clauses with Prepositions' },
                    { q: 'Having ___ the report, she submitted it immediately.', type: 'mcq', options: ['complete', 'completed', 'completing', 'to complete'], correct: 1, topic: 'Perfect Participles' },
                    { q: 'Rarely ___ such dedication in employees.', type: 'mcq', options: ['one sees', 'does one see', 'sees one', 'one does see'], correct: 1, topic: 'Inversion - Negative Adverbs' },
                    { q: 'It is imperative that students ___ academic integrity.', type: 'mcq', options: ['maintain', 'maintains', 'maintained', 'will maintain'], correct: 0, topic: 'Subjunctive - It is imperative' },
                    { q: 'No sooner ___ the announcement than people started leaving.', type: 'mcq', options: ['was made', 'made', 'had been made', 'has been made'], correct: 2, topic: 'Inversion - No sooner' },
                    { q: 'The research ___ by several universities is groundbreaking.', type: 'mcq', options: ['conducting', 'conducted', 'to conduct', 'conducts'], correct: 1, topic: 'Past Participles as Adjectives' },
                    { q: 'Should you ___ any questions, please contact us.', type: 'mcq', options: ['having', 'to have', 'have', 'had'], correct: 2, topic: 'Inversion - Should/Were/Had' }
                ]
            }
        };
        function selectLevel(level) {
            selectedLevel = level;
            document.getElementById('levelSelection').classList.remove('active');
            document.getElementById('variantSelection').classList.add('active');
        }

        function selectVariant(variant) {
            selectedVariant = variant;
            document.getElementById('initialScreens').style.display = 'none';
            document.getElementById('testInterface').style.display = 'flex';
            
            // Start session timer
            startSessionTimer();
            
            navigateToSection('Listening');
        }
        
        // ============================================
        // SESSION TIMER FUNCTIONS
        // ============================================
        function startSessionTimer() {
            sessionStartTime = Date.now();
            updateTimerDisplay();
            sessionTimerInterval = setInterval(updateTimerDisplay, 1000);
        }
        
        function stopSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = null;
            }
        }
        
        function updateTimerDisplay() {
            if (!sessionStartTime) return;
            const elapsed = Date.now() - sessionStartTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const display = document.getElementById('timerDisplay');
            if (display) {
                display.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }
        
        function getSessionDuration() {
            if (!sessionStartTime) return '00:00:00';
            const elapsed = Date.now() - sessionStartTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // ============================================
        // GOOGLE MEET FUNCTIONS
        // ============================================
        function openGoogleMeet() {
            // Open Google Meet in a new tab where user can start instant meeting
            window.open('https://meet.google.com/new', '_blank');
            showNotification('Google Meet opened in new tab!');
        }

        function navigateToSection(sectionName) {
            saveAnswers();
            currentSection = sectionName;
            
            // Update sidebar
            sections.forEach(s => {
                document.getElementById(`nav-${s}`).classList.remove('active');
            });
            document.getElementById(`nav-${sectionName}`).classList.add('active');
            
            loadSection(sectionName);
        }

        function loadSection(sectionName) {
            const sectionData = testData[selectedLevel][sectionName];
            let html = `<h2 style="color: #2c3e50; margin-bottom: 20px;">${sectionName} Section</h2>`;

            if (sectionName === 'Listening') {
                // Check if this section has variants
                const data = sectionData.variants ? sectionData.variants[selectedVariant] : sectionData;
                
                // Determine the video/audio URL to use
                let videoSrc = data.videoUrl || data.youtubeEmbed || '';
                let hasValidVideo = videoSrc && !videoSrc.includes('YOUR_AUDIO_URL') && !videoSrc.includes('dQw4w9WgXcQ');
                let hasValidAudio = data.audioUrl && !data.audioUrl.includes('YOUR_AUDIO_URL');
                
                html += `
                    <div class="instruction-note">
                        üéß ${data.description || 'Listen carefully and answer the questions below'}. You can replay as needed.
                    </div>
                    <div class="media-container">
                `;
                
                if (hasValidVideo) {
                    html += `<iframe 
                        class="video-player" 
                        width="100%" 
                        height="450" 
                        src="${videoSrc}" 
                        frameborder="0" 
                        allow="autoplay; encrypted-media" 
                        allowfullscreen></iframe>`;
                } else if (hasValidAudio) {
                    html += `<audio class="audio-player" controls>
                        <source src="${data.audioUrl}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>`;
                } else {
                    html += `<div style="padding: 40px; text-align: center; background: #fff3e0; border-radius: 10px; border: 2px dashed #ff8c00;">
                        <p style="font-size: 1.2em; color: #e65100;">‚ö†Ô∏è No Media Configured</p>
                        <p style="color: #666;">Please add a video or audio URL in the code.</p>
                    </div>`;
                }
                
                html += `</div>`;
                html += `<button class="show-answers-btn" onclick="toggleShowAllAnswers('${sectionName}')" id="showAnswersBtn_${sectionName}">
                    üëÅÔ∏è Show All Answers
                </button>`;
                data.questions.forEach((q, i) => {
                    html += createQuestion(sectionName, i, q);
                });
            } else if (sectionName === 'Reading') {
                const data = sectionData.variants ? sectionData.variants[selectedVariant] : sectionData;
                html += `
                    <div class="instruction-note">
                        üìñ Read the passage carefully and answer the questions that follow.
                    </div>
                    <div class="reading-text">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Reading Passage</h3>
                        <p>${data.text}</p>
                    </div>
                `;
                html += `<button class="show-answers-btn" onclick="toggleShowAllAnswers('${sectionName}')" id="showAnswersBtn_${sectionName}">
                    üëÅÔ∏è Show All Answers
                </button>`;
                data.questions.forEach((q, i) => {
                    html += createQuestion(sectionName, i, q);
                });
            } else if (sectionName === 'Writing') {
                const data = sectionData.variants ? sectionData.variants[selectedVariant] : sectionData;
                html += `
                    <div class="instruction-note">
                        ‚úçÔ∏è Complete both writing tasks. Take your time to plan and organize your ideas.
                    </div>
                    <div class="question">
                        <h4>Task 1: ${selectedLevel === 'A0' ? 'Translation' : 'Chart Description'}</h4>
                        ${data.chartUrl ? `<img src="${data.chartUrl}" alt="Chart" class="chart-image">` : ''}
                        <p style="color: #7f8c8d; margin: 10px 0;">${data.task1}</p>
                        <textarea id="${sectionName}_task1" rows="8" placeholder="Write your answer here..." name="writing_task1"></textarea>
                        <div class="ai-section">
                            <p class="ai-section-title">AI Teacher Assistant</p>
                            <button id="aiWritingBtn1" class="ai-assist-btn" onclick="getWritingAIFeedback(0)">ü§ñ Get AI Feedback</button>
                            <div id="aiWritingFeedback1"></div>
                        </div>
                    </div>
                    <div class="question">
                        <h4>Task 2: ${selectedLevel === 'A0' ? 'Short Writing' : 'Essay Planning'}</h4>
                        <p style="color: #7f8c8d; margin: 10px 0;">${data.task2}</p>
                        <textarea id="${sectionName}_task2" rows="10" placeholder="Write your answer here..." name="writing_task2"></textarea>
                        <div class="ai-section">
                            <p class="ai-section-title">AI Teacher Assistant</p>
                            <button id="aiWritingBtn2" class="ai-assist-btn" onclick="getWritingAIFeedback(1)">ü§ñ Get AI Feedback</button>
                            <div id="aiWritingFeedback2"></div>
                        </div>
                    </div>
                `;
            } else if (sectionName === 'Speaking') {
                const data = sectionData.variants ? sectionData.variants[selectedVariant] : sectionData;
                html += `
                    <div class="instruction-note">
                        üó£Ô∏è ${data.instruction}
                    </div>
                    <div class="question">
                        <h4>Part 1: General Questions</h4>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">Practice answering these questions aloud:</p>
                        ${data.part1.map((q, i) => `<p style="margin: 12px 0; padding: 10px; background: white; border-radius: 6px;"><strong>Q${i+1}:</strong> ${q}</p>`).join('')}
                    </div>
                    <div class="cue-card">
                        <h4>Part 2: Cue Card</h4>
                        <p style="margin: 15px 0; line-height: 1.8;">${data.part2}</p>
                        <span class="timer">Preparation time: 1 minute | Speaking time: 2 minutes</span>
                    </div>
                `;
                
                if (data.part3) {
                    html += `
                        <div class="question">
                            <h4>Part 3: Discussion Questions</h4>
                            <p style="color: #7f8c8d; margin-bottom: 15px;">Discuss these more complex topics:</p>
                            ${data.part3.map((q, i) => `<p style="margin: 12px 0; padding: 10px; background: white; border-radius: 6px;"><strong>Q${i+1}:</strong> ${q}</p>`).join('')}
                        </div>
                    `;
                }
                
                html += `
                    <div class="question">
                        <h4>üìù Teacher's Observation Notes</h4>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">Record your observations about the student's speaking performance:</p>
                        <textarea id="speaking_notes" name="speaking_notes" rows="6" placeholder="Enter your observations about fluency, pronunciation, grammar usage, vocabulary range, etc..."></textarea>
                        <div class="ai-section">
                            <p class="ai-section-title">AI Assessment Assistant</p>
                            <button id="aiSpeakingBtn" class="ai-assist-btn" onclick="getSpeakingAIFeedback()">ü§ñ Get AI Assessment Help</button>
                            <div id="aiSpeakingFeedback"></div>
                        </div>
                    </div>
                `;
            } else if (sectionName === 'Grammar') {
                const data = sectionData.variants ? sectionData.variants[selectedVariant] : sectionData;
                html += `
                    <div class="instruction-note">
                        üìù Complete the grammar exercises below. Choose the best answer for each question.
                    </div>
                `;
                html += `<button class="show-answers-btn" onclick="toggleShowAllAnswers('${sectionName}')" id="showAnswersBtn_${sectionName}">
                    üëÅÔ∏è Show All Answers
                </button>`;
                data.forEach((q, i) => {
                    html += createQuestion(sectionName, i, q);
                });
            }

            document.getElementById('testContent').innerHTML = html;
        }

        function createQuestion(section, index, q) {
            const qId = `${section}_${index}`;
            
            // Determine the correct answer text for display
            let answerText = '';
            if (q.type === 'mcq') {
                answerText = q.options[q.correct];
            } else if (q.type === 'tf') {
                answerText = q.correct ? 'True' : 'False';
            } else if (q.type === 'short') {
                answerText = q.correct;
            } else if (q.type === 'sentence') {
                answerText = q.answer || q.correct;
            } else if (q.type === 'views') {
                const viewsMap = { 'yes': 'Yes (Author agrees)', 'no': 'No (Author disagrees)', 'notgiven': 'Not Given' };
                answerText = viewsMap[q.answer] || q.answer;
            } else if (q.type === 'match') {
                answerText = 'Check matching pairs in the question';
            }
            
            let html = `<div class="question">
                <div class="question-header">
                    <h4>Question ${index + 1}</h4>
                    <button class="hint-btn" onclick="toggleAnswer('${qId}')" title="Show Answer">üí°</button>
                </div>
                <p>${q.q}</p>`;

            if (q.type === 'mcq') {
                html += '<div class="options">';
                q.options.forEach((opt, i) => {
                    html += `
                        <div class="option">
                            <input type="radio" id="${qId}_${i}" name="${qId}" value="${i}">
                            <label for="${qId}_${i}">${opt}</label>
                        </div>
                    `;
                });
                html += '</div>';
            } else if (q.type === 'tf') {
                html += `
                    <div class="options">
                        <div class="option">
                            <input type="radio" id="${qId}_true" name="${qId}" value="true">
                            <label for="${qId}_true">True</label>
                        </div>
                        <div class="option">
                            <input type="radio" id="${qId}_false" name="${qId}" value="false">
                            <label for="${qId}_false">False</label>
                        </div>
                    </div>
                `;
            } else if (q.type === 'short') {
                html += `<input type="text" id="${qId}" placeholder="Type your answer...">`;
            } else if (q.type === 'sentence') {
                html += `<p style="margin: 10px 0; color: #7f8c8d;">${q.stem} ___</p>`;
                html += `<input type="text" id="${qId}" placeholder="Complete the sentence...">`;
            } else if (q.type === 'match') {
                html += '<div class="match-container">';
                html += '<div><strong>Items:</strong>';
                q.pairs.forEach((pair, i) => {
                    html += `<div class="match-item">${pair[0]}</div>`;
                });
                html += '</div><div><strong>Match with:</strong>';
                q.pairs.forEach((pair, i) => {
                    html += `<div class="match-item">
                        <select id="${qId}_${i}" style="width: 100%; padding: 5px;">
                            <option value="">Select...</option>
                            ${q.pairs.map((p, j) => `<option value="${j}">${p[1]}</option>`).join('')}
                        </select>
                    </div>`;
                });
                html += '</div></div>';
            } else if (q.type === 'views') {
                html += `<p style="margin: 10px 0; color: #7f8c8d;">Statement: "${q.statement}"</p>`;
                html += `
                    <div class="options">
                        <div class="option">
                            <input type="radio" id="${qId}_yes" name="${qId}" value="yes">
                            <label for="${qId}_yes">Yes (Author agrees)</label>
                        </div>
                        <div class="option">
                            <input type="radio" id="${qId}_no" name="${qId}" value="no">
                            <label for="${qId}_no">No (Author disagrees)</label>
                        </div>
                        <div class="option">
                            <input type="radio" id="${qId}_notgiven" name="${qId}" value="notgiven">
                            <label for="${qId}_notgiven">Not Given</label>
                        </div>
                    </div>
                `;
            }

            html += `<div id="answer_${qId}" class="answer-key">‚úÖ Answer: ${answerText}</div>`;
            html += '</div>';
            return html;
        }

        function toggleAnswer(qId) {
            const answerDiv = document.getElementById('answer_' + qId);
            if (answerDiv) {
                answerDiv.classList.toggle('show');
            }
        }

        function toggleShowAllAnswers(sectionName) {
            const btn = document.getElementById(`showAnswersBtn_${sectionName}`);
            const isShowing = btn.classList.contains('active');
            
            const sectionData = testData[selectedLevel][sectionName];
            let data;
            if (sectionData.variants) {
                data = sectionData.variants[selectedVariant];
            } else {
                data = sectionData;
            }
            const questions = sectionName === 'Grammar' ? data : data.questions;
            
            if (isShowing) {
                // Hide all answers and remove highlighting
                btn.classList.remove('active');
                btn.innerHTML = 'üëÅÔ∏è Show All Answers';
                
                questions.forEach((q, i) => {
                    const qId = `${sectionName}_${i}`;
                    const answerDiv = document.getElementById('answer_' + qId);
                    if (answerDiv) {
                        answerDiv.classList.remove('show');
                    }
                    
                    // Remove highlighting from options
                    const options = document.querySelectorAll(`input[name="${qId}"]`);
                    options.forEach(opt => {
                        const optionDiv = opt.closest('.option');
                        if (optionDiv) {
                            optionDiv.classList.remove('correct-answer', 'wrong-answer');
                            const indicator = optionDiv.querySelector('.answer-indicator');
                            if (indicator) indicator.remove();
                        }
                    });
                    
                    // Remove input answer displays
                    const inputDisplay = document.getElementById(`input_display_${qId}`);
                    if (inputDisplay) {
                        inputDisplay.classList.remove('show');
                    }
                });
            } else {
                // Show all answers with highlighting
                btn.classList.add('active');
                btn.innerHTML = 'üôà Hide All Answers';
                
                questions.forEach((q, i) => {
                    const qId = `${sectionName}_${i}`;
                    const answerDiv = document.getElementById('answer_' + qId);
                    if (answerDiv) {
                        answerDiv.classList.add('show');
                    }
                    
                    // Highlight correct/wrong answers for MCQ, TF, Views
                    if (q.type === 'mcq') {
                        const selected = document.querySelector(`input[name="${qId}"]:checked`);
                        const options = document.querySelectorAll(`input[name="${qId}"]`);
                        
                        options.forEach((opt, optIndex) => {
                            const optionDiv = opt.closest('.option');
                            if (optionDiv) {
                                optionDiv.classList.remove('correct-answer', 'wrong-answer');
                                const existingIndicator = optionDiv.querySelector('.answer-indicator');
                                if (existingIndicator) existingIndicator.remove();
                                
                                if (optIndex === q.correct) {
                                    optionDiv.classList.add('correct-answer');
                                    const indicator = document.createElement('span');
                                    indicator.className = 'answer-indicator correct';
                                    indicator.textContent = '‚úì Correct';
                                    optionDiv.appendChild(indicator);
                                } else if (selected && opt === selected) {
                                    optionDiv.classList.add('wrong-answer');
                                    const indicator = document.createElement('span');
                                    indicator.className = 'answer-indicator wrong';
                                    indicator.textContent = '‚úó Your answer';
                                    optionDiv.appendChild(indicator);
                                }
                            }
                        });
                    } else if (q.type === 'tf') {
                        const selected = document.querySelector(`input[name="${qId}"]:checked`);
                        const correctValue = String(q.correct);
                        const options = document.querySelectorAll(`input[name="${qId}"]`);
                        
                        options.forEach(opt => {
                            const optionDiv = opt.closest('.option');
                            if (optionDiv) {
                                optionDiv.classList.remove('correct-answer', 'wrong-answer');
                                const existingIndicator = optionDiv.querySelector('.answer-indicator');
                                if (existingIndicator) existingIndicator.remove();
                                
                                if (opt.value === correctValue) {
                                    optionDiv.classList.add('correct-answer');
                                    const indicator = document.createElement('span');
                                    indicator.className = 'answer-indicator correct';
                                    indicator.textContent = '‚úì Correct';
                                    optionDiv.appendChild(indicator);
                                } else if (selected && opt === selected) {
                                    optionDiv.classList.add('wrong-answer');
                                    const indicator = document.createElement('span');
                                    indicator.className = 'answer-indicator wrong';
                                    indicator.textContent = '‚úó Your answer';
                                    optionDiv.appendChild(indicator);
                                }
                            }
                        });
                    } else if (q.type === 'views') {
                        const selected = document.querySelector(`input[name="${qId}"]:checked`);
                        const correctValue = q.answer;
                        const options = document.querySelectorAll(`input[name="${qId}"]`);
                        
                        options.forEach(opt => {
                            const optionDiv = opt.closest('.option');
                            if (optionDiv) {
                                optionDiv.classList.remove('correct-answer', 'wrong-answer');
                                const existingIndicator = optionDiv.querySelector('.answer-indicator');
                                if (existingIndicator) existingIndicator.remove();
                                
                                if (opt.value === correctValue) {
                                    optionDiv.classList.add('correct-answer');
                                    const indicator = document.createElement('span');
                                    indicator.className = 'answer-indicator correct';
                                    indicator.textContent = '‚úì Correct';
                                    optionDiv.appendChild(indicator);
                                } else if (selected && opt === selected) {
                                    optionDiv.classList.add('wrong-answer');
                                    const indicator = document.createElement('span');
                                    indicator.className = 'answer-indicator wrong';
                                    indicator.textContent = '‚úó Your answer';
                                    optionDiv.appendChild(indicator);
                                }
                            }
                        });
                    } else if (q.type === 'short' || q.type === 'sentence') {
                        const inputEl = document.getElementById(qId);
                        if (inputEl) {
                            const userAnswer = inputEl.value.trim().toLowerCase();
                            const correctAnswer = (q.answer || q.correct || '').toLowerCase().trim();
                            const isCorrect = userAnswer && (
                                userAnswer === correctAnswer ||
                                userAnswer.includes(correctAnswer) ||
                                correctAnswer.includes(userAnswer)
                            );
                            
                            // Create or update display element
                            let displayEl = document.getElementById(`input_display_${qId}`);
                            if (!displayEl) {
                                displayEl = document.createElement('div');
                                displayEl.id = `input_display_${qId}`;
                                displayEl.className = 'input-answer-display';
                                inputEl.parentNode.insertBefore(displayEl, inputEl.nextSibling);
                            }
                            
                            if (userAnswer) {
                                displayEl.className = `input-answer-display show ${isCorrect ? 'correct' : 'wrong'}`;
                                displayEl.innerHTML = isCorrect 
                                    ? `‚úì Your answer is correct!`
                                    : `‚úó Your answer: "${inputEl.value}" ‚Äî Correct answer: "${q.answer || q.correct}"`;
                            } else {
                                displayEl.className = 'input-answer-display show wrong';
                                displayEl.innerHTML = `‚ö†Ô∏è No answer provided ‚Äî Correct answer: "${q.answer || q.correct}"`;
                            }
                        }
                    }
                });
            }
        }

        function saveAnswers() {
            const sectionName = currentSection;
            answers[sectionName] = {};

            if (sectionName === 'Writing') {
                const task1El = document.getElementById(`${sectionName}_task1`);
                const task2El = document.getElementById(`${sectionName}_task2`);
                if (task1El) answers[sectionName].task1 = task1El.value;
                if (task2El) answers[sectionName].task2 = task2El.value;
            } else if (sectionName === 'Speaking') {
                // Speaking section doesn't require saving text answers
                answers[sectionName].completed = true;
            } else {
                const sectionData = testData[selectedLevel][sectionName];
                // Handle variants structure for Listening
                let data;
                if (sectionData.variants) {
                    data = sectionData.variants[selectedVariant];
                } else {
                    data = sectionData;
                }
                const questions = sectionName === 'Grammar' ? data : data.questions;
                
                questions.forEach((q, i) => {
                    const qId = `${sectionName}_${i}`;
                    if (q.type === 'mcq' || q.type === 'tf' || q.type === 'views') {
                        const selected = document.querySelector(`input[name="${qId}"]:checked`);
                        answers[sectionName][i] = selected ? selected.value : null;
                    } else if (q.type === 'short' || q.type === 'sentence') {
                        const el = document.getElementById(qId);
                        answers[sectionName][i] = el ? el.value : '';
                    } else if (q.type === 'match') {
                        answers[sectionName][i] = [];
                        q.pairs.forEach((pair, j) => {
                            const el = document.getElementById(`${qId}_${j}`);
                            if (el) answers[sectionName][i].push(el.value);
                        });
                    }
                });
            }
            
            completedSections.add(sectionName);
            document.getElementById(`nav-${sectionName}`).classList.add('completed');
        }

        function showResults() {
            saveAnswers();
            document.getElementById('testInterface').style.display = 'none';
            document.getElementById('resultsInterface').style.display = 'block';

            let html = `<div class="results">`;
            let totalScore = 0;
            let maxScore = 0;

            sections.forEach(section => {
                if (section === 'Writing') {
                    const writingAnswers = answers['Writing'] || {};
                    const hasTask1 = writingAnswers.task1 && writingAnswers.task1.trim();
                    const hasTask2 = writingAnswers.task2 && writingAnswers.task2.trim();
                    
                    html += `
                        <div class="result-section">
                            <h3>${section}</h3>
                            <p style="color: #7f8c8d;">This section requires manual evaluation by an instructor.</p>
                            <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <strong>‚úì Your responses have been recorded for review.</strong>
                            </div>
                            ${(hasTask1 || hasTask2) ? `
                                <button class="writing-answer-btn" onclick="toggleWritingAnswers()">
                                    üìù Show Writing Answers
                                </button>
                                <div id="writingAnswerContainer" class="writing-answer-container">
                                    ${hasTask1 ? `
                                        <div style="margin-bottom: 20px;">
                                            <h4>Task 1 Answer <button class="copy-btn" onclick="copyToClipboard('task1Content', this)">üìã Copy</button></h4>
                                            <pre id="task1Content">${escapeHtml(writingAnswers.task1)}</pre>
                                        </div>
                                    ` : `<p style="color: #7f8c8d; font-style: italic;">Task 1: No answer provided</p>`}
                                    ${hasTask2 ? `
                                        <div>
                                            <h4>Task 2 Answer <button class="copy-btn" onclick="copyToClipboard('task2Content', this)">üìã Copy</button></h4>
                                            <pre id="task2Content">${escapeHtml(writingAnswers.task2)}</pre>
                                        </div>
                                    ` : `<p style="color: #7f8c8d; font-style: italic;">Task 2: No answer provided</p>`}
                                </div>
                            ` : `<p style="color: #e65100; margin-top: 10px;">‚ö†Ô∏è No writing responses were submitted.</p>`}
                        </div>
                    `;
                } else if (section === 'Speaking') {
                    html += `
                        <div class="result-section">
                            <h3>${section}</h3>
                            <p style="color: #7f8c8d;">This section requires manual evaluation by an instructor.</p>
                            <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <strong>‚úì Your responses have been recorded for review.</strong>
                            </div>
                        </div>
                    `;
                } else {
                    const result = calculateSectionScore(section);
                    totalScore += result.score;
                    maxScore += result.total;

                    html += `
                        <div class="result-section">
                            <h3>${section}</h3>
                            <div class="score">${result.score} / ${result.total}</div>
                            <p style="color: #7f8c8d; margin: 10px 0;">Performance: ${result.percentage}%</p>
                            
                            ${result.recommendations.length > 0 ? 
                                `<div style="margin-top: 15px;">
                                    <strong style="color: #2c3e50;">Recommendations:</strong>
                                    ${result.recommendations.map(rec => 
                                        `<div class="recommendation">üìå ${rec}</div>`
                                    ).join('')}
                                </div>` : 
                                `<div class="recommendation" style="background: #e8f5e9; color: #2e7d32;">
                                    ‚úÖ Excellent performance across all question types!
                                </div>`
                            }
                            
                            ${section === 'Grammar' && result.grammarTopics ? 
                                `<div style="margin-top: 15px;">
                                    <strong style="color: #2c3e50;">Grammar Topics to Review:</strong>
                                    ${result.grammarTopics.map(topic => 
                                        `<div class="grammar-topic">üìö ${topic}</div>`
                                    ).join('')}
                                </div>` : ''
                            }
                        </div>
                    `;
                }
            });

            const overallPercentage = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
            
            html += `
                <div class="result-section" style="border-left-color: #ff8c00; background: linear-gradient(135deg, #fff5f0 0%, #f0f7ff 100%);">
                    <h3>Overall Assessment</h3>
                    <div class="score">${totalScore} / ${maxScore}</div>
                    <p style="color: #7f8c8d; margin: 10px 0;">Overall Performance: ${overallPercentage}%</p>
                    <div class="recommendation">
                        <strong>Level Assessment:</strong> 
                        ${overallPercentage >= 80 ? 'Excellent! Strong proficiency at this level. Consider advancing to the next level.' :
                          overallPercentage >= 60 ? 'Good work! Solid understanding with room for improvement in specific areas.' :
                          overallPercentage >= 40 ? 'Fair performance. Focus on the weak areas identified above for improvement.' :
                          'Additional practice needed. Review fundamentals and consider working with an instructor.'}
                    </div>
                </div>
            `;

            html += `</div>`;
            document.getElementById('resultsContent').innerHTML = html;
            window.scrollTo(0, 0);
        }

        function calculateSectionScore(section) {
            const sectionData = testData[selectedLevel][section];
            // Handle variants structure for Listening
            let data;
            if (sectionData.variants) {
                data = sectionData.variants[selectedVariant];
            } else {
                data = sectionData;
            }
            const questions = section === 'Grammar' ? data : data.questions;
            const userAnswers = answers[section] || {};

            let score = 0;
            let total = questions.length;
            const typeStats = {};
            const grammarTopicStats = {};

            questions.forEach((q, i) => {
                const userAnswer = userAnswers[i];
                let correct = false;

                if (q.type === 'mcq') {
                    correct = userAnswer == q.correct;
                } else if (q.type === 'tf') {
                    correct = userAnswer === String(q.correct);
                } else if (q.type === 'short') {
                    if (userAnswer && q.correct) {
                        const userLower = userAnswer.toLowerCase().trim();
                        const correctLower = q.correct.toLowerCase().trim();
                        // Case-insensitive exact match, or check if either contains the other
                        correct = userLower === correctLower || 
                                  userLower.includes(correctLower) || 
                                  correctLower.includes(userLower);
                    }
                } else if (q.type === 'sentence') {
                    // Sentence type uses 'answer' property instead of 'correct'
                    const correctAnswer = q.answer || q.correct;
                    if (userAnswer && correctAnswer) {
                        const userLower = userAnswer.toLowerCase().trim();
                        const correctLower = correctAnswer.toLowerCase().trim();
                        // Case-insensitive exact match, or check if either contains the other
                        correct = userLower === correctLower || 
                                  userLower.includes(correctLower) || 
                                  correctLower.includes(userLower);
                    }
                } else if (q.type === 'match') {
                    if (Array.isArray(userAnswer) && q.correctPairs) {
                        let matchCount = 0;
                        userAnswer.forEach((ans, j) => {
                            if (q.correctPairs.some(pair => 
                                pair[0] === q.pairs[j][0] && pair[1] === q.pairs[parseInt(ans)][1]
                            )) {
                                matchCount++;
                            }
                        });
                        correct = matchCount >= q.correctPairs.length;
                    }
                } else if (q.type === 'views') {
                    correct = userAnswer === q.answer;
                }

                if (correct) score++;

                // Track by question type
                if (!typeStats[q.type]) {
                    typeStats[q.type] = { correct: 0, total: 0 };
                }
                typeStats[q.type].total++;
                if (correct) typeStats[q.type].correct++;

                // Track grammar topics
                if (section === 'Grammar' && q.topic) {
                    if (!grammarTopicStats[q.topic]) {
                        grammarTopicStats[q.topic] = { correct: 0, total: 0 };
                    }
                    grammarTopicStats[q.topic].total++;
                    if (correct) grammarTopicStats[q.topic].correct++;
                }
            });

            const percentage = Math.round((score / total) * 100);
            const recommendations = [];

            Object.keys(typeStats).forEach(type => {
                const stat = typeStats[type];
                const typePercentage = Math.round((stat.correct / stat.total) * 100);
                const typeName = {
                    'mcq': 'Multiple Choice',
                    'tf': 'True/False',
                    'short': 'Short Answer',
                    'sentence': 'Sentence Completion',
                    'match': 'Matching',
                    'views': 'Identifying Writer\'s Views'
                }[type] || type;

                if (typePercentage < 60) {
                    recommendations.push(`${typeName}: ${stat.correct}/${stat.total} - Work on ${typeName} question types`);
                } else if (typePercentage < 80) {
                    recommendations.push(`${typeName}: ${stat.correct}/${stat.total} - Good progress, continue practicing`);
                }
            });

            // Grammar topics analysis
            let grammarTopics = [];
            if (section === 'Grammar') {
                Object.keys(grammarTopicStats).forEach(topic => {
                    const stat = grammarTopicStats[topic];
                    const topicPercentage = Math.round((stat.correct / stat.total) * 100);
                    if (topicPercentage < 70) {
                        grammarTopics.push(`${topic} (${stat.correct}/${stat.total} correct)`);
                    }
                });
            }

            return { 
                score, 
                total, 
                percentage, 
                recommendations,
                grammarTopics: grammarTopics.length > 0 ? grammarTopics : null
            };
        }

        function toggleWritingAnswers() {
            const container = document.getElementById('writingAnswerContainer');
            const btn = event.target;
            if (container) {
                container.classList.toggle('show');
                if (container.classList.contains('show')) {
                    btn.innerHTML = 'üôà Hide Writing Answers';
                } else {
                    btn.innerHTML = 'üìù Show Writing Answers';
                }
            }
        }

        function copyToClipboard(elementId, btn) {
            const element = document.getElementById(elementId);
            if (element) {
                const text = element.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    btn.classList.add('copied');
                    btn.textContent = '‚úì Copied!';
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.textContent = 'üìã Copy';
                    }, 2000);
                }).catch(err => {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    btn.classList.add('copied');
                    btn.textContent = '‚úì Copied!';
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.textContent = 'üìã Copy';
                    }, 2000);
                });
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function restartTest() {
            // Stop session timer
            stopSessionTimer();
            sessionStartTime = null;
            
            // Clear meet link input
            currentMeetLink = null;
            const meetLinkInput = document.getElementById('meetLinkInput');
            if (meetLinkInput) {
                meetLinkInput.value = '';
                meetLinkInput.style.borderColor = '#e2e8f0';
            }
            const copyMeetBtn = document.getElementById('copyMeetBtn');
            if (copyMeetBtn) copyMeetBtn.disabled = true;
            
            // Clear all state
            selectedLevel = '';
            selectedVariant = 0;
            currentSection = 'Listening';
            answers = {};
            completedSections.clear();
            
            // Clear the test content area
            document.getElementById('testContent').innerHTML = '';
            document.getElementById('resultsContent').innerHTML = '';
            
            // Clear export fields
            const studentNameField = document.getElementById('studentName');
            const descriptionField = document.getElementById('testDescription');
            if (studentNameField) studentNameField.value = '';
            if (descriptionField) descriptionField.value = '';
            
            // Reset UI
            document.getElementById('resultsInterface').style.display = 'none';
            document.getElementById('testInterface').style.display = 'none';
            document.getElementById('initialScreens').style.display = 'block';
            document.getElementById('levelSelection').classList.add('active');
            document.getElementById('variantSelection').classList.remove('active');
            
            // Reset sidebar
            sections.forEach(s => {
                document.getElementById(`nav-${s}`).classList.remove('active', 'completed');
            });
            
            // Reset timer display
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) timerDisplay.textContent = '00:00:00';
        }

        function backToMainMenu() {
            if (confirm('Are you sure you want to go back to the main menu? Your progress will be lost.')) {
                restartTest();
            }
        }

        // Export to Word functionality
        async function exportToWord() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Generating...';

            try {
                // Use globally loaded docx library
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = window.docx;

                const studentName = document.getElementById('studentName').value || '________________';
                const testDescription = document.getElementById('testDescription').value || '';
                const testDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                const children = [];

                // Title
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Language Level Assessment Results', bold: true, size: 48 })],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 300 }
                }));

                // Student Info Section
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Student Name: ', bold: true, size: 24 }), new TextRun({ text: studentName, size: 24 })],
                    spacing: { after: 100 }
                }));

                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Test Level: ', bold: true, size: 24 }), new TextRun({ text: selectedLevel, size: 24 })],
                    spacing: { after: 100 }
                }));

                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Variant: ', bold: true, size: 24 }), new TextRun({ text: String(selectedVariant), size: 24 })],
                    spacing: { after: 100 }
                }));

                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Date: ', bold: true, size: 24 }), new TextRun({ text: testDate, size: 24 })],
                    spacing: { after: 200 }
                }));

                if (testDescription) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: 'Description / Notes:', bold: true, size: 24 })],
                        spacing: { before: 100 }
                    }));
                    children.push(new Paragraph({
                        children: [new TextRun({ text: testDescription, size: 24, italics: true })],
                        spacing: { after: 300 }
                    }));
                }

                // Divider
                children.push(new Paragraph({
                    children: [new TextRun({ text: '‚îÄ'.repeat(50), size: 24 })],
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 200, after: 200 }
                }));

                // Process each section
                let totalScore = 0;
                let maxScore = 0;

                for (const section of sections) {
                    // Section Header
                    children.push(new Paragraph({
                        children: [new TextRun({ text: `${section} Section`, bold: true, size: 32 })],
                        spacing: { before: 300, after: 150 }
                    }));

                    if (section === 'Writing') {
                        // Writing Section - Show student answers
                        children.push(new Paragraph({
                            children: [new TextRun({ text: 'Score: ', bold: true, size: 24 }), new TextRun({ text: 'Manual Evaluation Required', size: 24, italics: true })],
                            spacing: { after: 150 }
                        }));

                        const writingAnswers = answers['Writing'] || {};
                        
                        // Task 1
                        children.push(new Paragraph({
                            children: [new TextRun({ text: 'Task 1 Answer:', bold: true, size: 24 })],
                            spacing: { before: 150 }
                        }));
                        
                        if (writingAnswers.task1 && writingAnswers.task1.trim()) {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: writingAnswers.task1, size: 22 })],
                                spacing: { after: 150 },
                                indent: { left: 360 }
                            }));
                        } else {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: '(No answer provided)', size: 22, italics: true })],
                                spacing: { after: 150 },
                                indent: { left: 360 }
                            }));
                        }

                        // Task 2
                        children.push(new Paragraph({
                            children: [new TextRun({ text: 'Task 2 Answer:', bold: true, size: 24 })],
                            spacing: { before: 150 }
                        }));
                        
                        if (writingAnswers.task2 && writingAnswers.task2.trim()) {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: writingAnswers.task2, size: 22 })],
                                spacing: { after: 200 },
                                indent: { left: 360 }
                            }));
                        } else {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: '(No answer provided)', size: 22, italics: true })],
                                spacing: { after: 200 },
                                indent: { left: 360 }
                            }));
                        }

                    } else if (section === 'Speaking') {
                        // Speaking Section - Empty space for transcribed answer
                        children.push(new Paragraph({
                            children: [new TextRun({ text: 'Score: ', bold: true, size: 24 }), new TextRun({ text: 'Manual Evaluation Required', size: 24, italics: true })],
                            spacing: { after: 150 }
                        }));

                        const sectionData = testData[selectedLevel][section];
                        const data = sectionData.variants ? sectionData.variants[selectedVariant] : sectionData;

                        // Part 1 Questions
                        children.push(new Paragraph({
                            children: [new TextRun({ text: 'Part 1 - General Questions:', bold: true, size: 24 })],
                            spacing: { before: 150, after: 100 }
                        }));

                        data.part1.forEach((q, i) => {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: `Q${i+1}: ${q}`, size: 22 })],
                                indent: { left: 360 }
                            }));
                            children.push(new Paragraph({
                                children: [new TextRun({ text: 'Answer: ________________________________________', size: 22 })],
                                spacing: { after: 150 },
                                indent: { left: 360 }
                            }));
                        });

                        // Part 2 Cue Card
                        children.push(new Paragraph({
                            children: [new TextRun({ text: 'Part 2 - Cue Card:', bold: true, size: 24 })],
                            spacing: { before: 150, after: 100 }
                        }));

                        children.push(new Paragraph({
                            children: [new TextRun({ text: data.part2, size: 22, italics: true })],
                            indent: { left: 360 }
                        }));

                        children.push(new Paragraph({
                            children: [new TextRun({ text: 'Transcribed Answer:', bold: true, size: 22 })],
                            spacing: { before: 150 },
                            indent: { left: 360 }
                        }));

                        // Empty lines for transcription
                        for (let i = 0; i < 6; i++) {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: '_'.repeat(70), size: 22 })],
                                spacing: { after: 100 },
                                indent: { left: 360 }
                            }));
                        }

                        // Part 3 if exists
                        if (data.part3) {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: 'Part 3 - Discussion Questions:', bold: true, size: 24 })],
                                spacing: { before: 200, after: 100 }
                            }));

                            data.part3.forEach((q, i) => {
                                children.push(new Paragraph({
                                    children: [new TextRun({ text: `Q${i+1}: ${q}`, size: 22 })],
                                    indent: { left: 360 }
                                }));
                                children.push(new Paragraph({
                                    children: [new TextRun({ text: 'Answer: ________________________________________', size: 22 })],
                                    spacing: { after: 150 },
                                    indent: { left: 360 }
                                }));
                            });
                        }

                    } else {
                        // Listening, Reading, Grammar - Score sections
                        const result = calculateSectionScore(section);
                        totalScore += result.score;
                        maxScore += result.total;

                        children.push(new Paragraph({
                            children: [
                                new TextRun({ text: 'Score: ', bold: true, size: 24 }),
                                new TextRun({ text: `${result.score} / ${result.total}`, size: 24, bold: true }),
                                new TextRun({ text: `  (${result.percentage}%)`, size: 24 })
                            ],
                            spacing: { after: 150 }
                        }));

                        // Performance level
                        let performanceLevel = '';
                        if (result.percentage >= 80) performanceLevel = 'Excellent';
                        else if (result.percentage >= 60) performanceLevel = 'Good';
                        else if (result.percentage >= 40) performanceLevel = 'Fair';
                        else performanceLevel = 'Needs Improvement';

                        children.push(new Paragraph({
                            children: [
                                new TextRun({ text: 'Performance: ', bold: true, size: 24 }),
                                new TextRun({ text: performanceLevel, size: 24 })
                            ],
                            spacing: { after: 150 }
                        }));

                        // Recommendations
                        if (result.recommendations.length > 0) {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: 'Recommendations:', bold: true, size: 24 })],
                                spacing: { before: 100, after: 50 }
                            }));

                            result.recommendations.forEach(rec => {
                                children.push(new Paragraph({
                                    children: [new TextRun({ text: `‚Ä¢ ${rec}`, size: 22 })],
                                    indent: { left: 360 },
                                    spacing: { after: 50 }
                                }));
                            });
                        } else {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: '‚úì Excellent performance across all question types!', size: 22, italics: true })],
                                spacing: { after: 100 }
                            }));
                        }

                        // Grammar topics to review
                        if (section === 'Grammar' && result.grammarTopics) {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: 'Grammar Topics to Review:', bold: true, size: 24 })],
                                spacing: { before: 100, after: 50 }
                            }));

                            result.grammarTopics.forEach(topic => {
                                children.push(new Paragraph({
                                    children: [new TextRun({ text: `‚Ä¢ ${topic}`, size: 22 })],
                                    indent: { left: 360 },
                                    spacing: { after: 50 }
                                }));
                            });
                        }
                    }

                    // Section divider
                    children.push(new Paragraph({
                        children: [new TextRun({ text: '‚îÄ'.repeat(40), size: 20, color: 'CCCCCC' })],
                        alignment: AlignmentType.CENTER,
                        spacing: { before: 100, after: 100 }
                    }));
                }

                // Overall Assessment
                const overallPercentage = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
                
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Overall Assessment', bold: true, size: 36 })],
                    spacing: { before: 300, after: 150 }
                }));

                children.push(new Paragraph({
                    children: [
                        new TextRun({ text: 'Total Score: ', bold: true, size: 28 }),
                        new TextRun({ text: `${totalScore} / ${maxScore}`, size: 28, bold: true }),
                        new TextRun({ text: `  (${overallPercentage}%)`, size: 28 })
                    ],
                    spacing: { after: 150 }
                }));

                let overallAssessment = '';
                if (overallPercentage >= 80) overallAssessment = 'Excellent! Strong proficiency at this level. Consider advancing to the next level.';
                else if (overallPercentage >= 60) overallAssessment = 'Good work! Solid understanding with room for improvement in specific areas.';
                else if (overallPercentage >= 40) overallAssessment = 'Fair performance. Focus on the weak areas identified above for improvement.';
                else overallAssessment = 'Additional practice needed. Review fundamentals and consider working with an instructor.';

                children.push(new Paragraph({
                    children: [new TextRun({ text: overallAssessment, size: 24, italics: true })],
                    spacing: { after: 300 }
                }));

                // Instructor Notes Section
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Instructor Notes:', bold: true, size: 28 })],
                    spacing: { before: 200, after: 100 }
                }));

                for (let i = 0; i < 5; i++) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: '_'.repeat(80), size: 22 })],
                        spacing: { after: 100 }
                    }));
                }

                // Create document
                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                size: { width: 12240, height: 15840 },
                                margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
                            }
                        },
                        children: children
                    }]
                });

                // Generate and download
                const buffer = await Packer.toBlob(doc);
                const url = URL.createObjectURL(buffer);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Assessment_Results_${selectedLevel}_${studentName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                btn.disabled = false;
                btn.innerHTML = '‚úì Downloaded!';
                setTimeout(() => {
                    btn.innerHTML = 'üì• Export to Word Document';
                }, 2000);

            } catch (error) {
                console.error('Export error:', error);
                btn.disabled = false;
                btn.innerHTML = '‚ùå Export Failed - Try Again';
                setTimeout(() => {
                    btn.innerHTML = 'üì• Export to Word Document';
                }, 3000);
            }
        }

        // Export from History
        async function exportHistoryToWord(assessmentId) {
            const assessment = assessmentHistory.find(a => a.id === assessmentId);
            if (!assessment) {
                showNotification('Assessment not found', 'error');
                return;
            }
            
            // Check if export has expired
            if (assessment.exportExpiry && new Date(assessment.exportExpiry) <= new Date()) {
                showNotification('Export has expired (24h limit)', 'error');
                return;
            }
            
            try {
                const { Document, Packer, Paragraph, TextRun, AlignmentType } = window.docx;
                
                const studentName = assessment.studentName || 'Unknown';
                const testDate = assessment.date?.toDate 
                    ? assessment.date.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
                    : new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                const children = [];
                
                // Title
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Language Level Assessment Results', bold: true, size: 48 })],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 300 }
                }));
                
                // Student Info
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Student Name: ', bold: true, size: 24 }), new TextRun({ text: studentName, size: 24 })],
                    spacing: { after: 100 }
                }));
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Test Level: ', bold: true, size: 24 }), new TextRun({ text: assessment.level, size: 24 })],
                    spacing: { after: 100 }
                }));
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Variant: ', bold: true, size: 24 }), new TextRun({ text: String(assessment.variant), size: 24 })],
                    spacing: { after: 100 }
                }));
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Date: ', bold: true, size: 24 }), new TextRun({ text: testDate, size: 24 })],
                    spacing: { after: 100 }
                }));
                if (assessment.sessionDuration) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: 'Session Duration: ', bold: true, size: 24 }), new TextRun({ text: assessment.sessionDuration, size: 24 })],
                        spacing: { after: 200 }
                    }));
                }
                
                // Section Scores
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Section Results', bold: true, size: 36 })],
                    spacing: { before: 200, after: 150 }
                }));
                
                Object.entries(assessment.scores || {}).forEach(([section, data]) => {
                    children.push(new Paragraph({
                        children: [
                            new TextRun({ text: `${section}: `, bold: true, size: 28 }),
                            new TextRun({ text: `${data.score}/${data.total} (${data.percentage}%)`, size: 28 })
                        ],
                        spacing: { after: 100 }
                    }));
                });
                
                // Overall
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Overall Assessment', bold: true, size: 36 })],
                    spacing: { before: 300, after: 150 }
                }));
                children.push(new Paragraph({
                    children: [
                        new TextRun({ text: 'Total Score: ', bold: true, size: 28 }),
                        new TextRun({ text: `${assessment.totalScore} / ${assessment.maxScore}`, size: 28, bold: true }),
                        new TextRun({ text: `  (${assessment.percentage}%)`, size: 28 })
                    ],
                    spacing: { after: 150 }
                }));
                
                // Recommendations
                if (assessment.recommendations?.length) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: 'Recommendations:', bold: true, size: 28 })],
                        spacing: { before: 200, after: 100 }
                    }));
                    assessment.recommendations.forEach(rec => {
                        children.push(new Paragraph({
                            children: [new TextRun({ text: `‚Ä¢ ${rec}`, size: 24 })],
                            spacing: { after: 50 }
                        }));
                    });
                }
                
                // Notes
                if (assessment.notes) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: 'Notes:', bold: true, size: 28 })],
                        spacing: { before: 200, after: 100 }
                    }));
                    children.push(new Paragraph({
                        children: [new TextRun({ text: assessment.notes, size: 24, italics: true })],
                        spacing: { after: 200 }
                    }));
                }
                
                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                size: { width: 12240, height: 15840 },
                                margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
                            }
                        },
                        children: children
                    }]
                });
                
                const buffer = await Packer.toBlob(doc);
                const url = URL.createObjectURL(buffer);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Assessment_${assessment.level}_${studentName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Downloaded! ‚úì');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export failed', 'error');
            }
        }

        // ============================================
        // GEMINI AI CONFIGURATION
        // ============================================
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚ö†Ô∏è  IMPORTANT: PASTE YOUR GEMINI API KEY BELOW  ‚ö†Ô∏è
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 1. Go to: https://aistudio.google.com/app/apikey
        // 2. Click "Create API Key" 
        // 3. Copy the key and paste it below (replace YOUR_KEY_HERE)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const GEMINI_API_KEY = 'AIzaSyBxdT6B4Bku-0OzTutedXKuN0wZ2cUk84g';
        
        // Using gemini-2.0-flash model (more reliable)
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
        
        // ============================================
        // GEMINI AI DIRECT API CALLS
        // ============================================
        
        async function callGeminiAPI(prompt) {
            // Check if API key is configured
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_KEY_HERE') {
                showNotification('‚ö†Ô∏è Please add your Gemini API key in the HTML file (search for YOUR_KEY_HERE)', 'error');
                console.error('‚ùå API KEY NOT SET! Open the HTML file and replace YOUR_KEY_HERE with your actual API key from https://aistudio.google.com/app/apikey');
                return null;
            }
            
            console.log('üöÄ Calling Gemini API...');
            
            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 1500,
                            topP: 0.8
                        }
                    })
                });
                
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('‚ùå Gemini API error:', error);
                    
                    const errorMsg = error.error?.message || 'Unknown error';
                    
                    if (response.status === 400) {
                        showNotification('Invalid request: ' + errorMsg, 'error');
                    } else if (response.status === 403) {
                        showNotification('API key not authorized. Enable Gemini API in Google Cloud Console.', 'error');
                    } else if (response.status === 404) {
                        showNotification('Invalid API key or model not found. Get a new key from aistudio.google.com', 'error');
                    } else if (response.status === 429) {
                        showNotification('Rate limit exceeded. Wait a moment and try again.', 'error');
                    } else {
                        showNotification('API Error (' + response.status + '): ' + errorMsg, 'error');
                    }
                    return null;
                }
                
                const data = await response.json();
                console.log('‚úÖ Gemini response received');
                
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    console.error('‚ùå No text in response:', data);
                    return null;
                }
                
                // Try to parse JSON from response
                try {
                    const cleanJson = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    return JSON.parse(cleanJson);
                } catch (e) {
                    return { rawText: text };
                }
                
            } catch (error) {
                console.error('‚ùå Network error:', error);
                showNotification('Failed to connect to AI service', 'error');
                return null;
            }
        }
        
        // ============================================
        // WRITING FEEDBACK
        // ============================================
        
        async function getWritingAIFeedback(taskIndex) {
            const taskNum = taskIndex + 1;
            const btn = document.getElementById('aiWritingBtn' + taskNum);
            const container = document.getElementById('aiWritingFeedback' + taskNum);
            if (!btn || !container) return;
            
            const textarea = document.querySelector('textarea[name="writing_task' + taskNum + '"]');
            if (!textarea || !textarea.value.trim() || textarea.value.trim().length < 10) {
                showNotification('Please write more content first (at least a few sentences)', 'error');
                return;
            }
            
            const levelData = testData[selectedLevel];
            let taskDescription = '';
            if (levelData?.Writing?.variants?.[selectedVariant]) {
                taskDescription = levelData.Writing.variants[selectedVariant]['task' + taskNum] || '';
            }
            
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = 'ü§ñ Analyzing...';
            container.innerHTML = '<div class="ai-loading">Processing your writing...</div>';
            
            const prompt = `You are an English language assessment assistant helping teachers evaluate student writing. Provide constructive feedback aligned to CEFR standards.

STUDENT LEVEL: ${selectedLevel}
WRITING TASK: ${taskDescription || 'General writing task'}

STUDENT'S RESPONSE:
---
${textarea.value}
---

Analyze this writing and respond with ONLY valid JSON (no markdown, no code blocks):

{
    "overallImpression": "2-3 sentences summarizing the writing quality",
    "strengths": ["strength 1", "strength 2", "strength 3"],
    "areasToImprove": ["area 1", "area 2", "area 3"],
    "grammarNotes": ["specific grammar observation 1", "observation 2"],
    "vocabularyNotes": ["vocabulary observation 1", "observation 2"],
    "suggestedScore": {
        "range": "X-Y out of 10",
        "reasoning": "brief justification for this range"
    },
    "teacherTip": "one specific actionable suggestion for the teacher"
}

RULES:
- Be encouraging and constructive
- Align expectations to ${selectedLevel} CEFR level
- Limit to 3 items per list
- This is TEACHER ASSISTANCE only, not final scoring
- Output ONLY the JSON object, nothing else`;
            
            try {
                showNotification('ü§ñ AI is analyzing...', 'info');
                const result = await callGeminiAPI(prompt);
                
                if (result) {
                    displayWritingFeedback(container, result);
                    showNotification('‚úì AI analysis complete', 'success');
                } else {
                    container.innerHTML = '<div class="ai-error">Could not generate feedback. Please try again.</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="ai-error">An error occurred. Please try again.</div>';
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = 'ü§ñ Get AI Feedback';
            }
        }
        
        function displayWritingFeedback(container, feedback) {
            if (!container || !feedback) return;
            
            if (feedback.rawText) {
                container.innerHTML = '<div class="ai-feedback-card"><div class="ai-feedback-header"><span class="ai-icon">ü§ñ</span><span>AI Feedback</span></div><div class="ai-feedback-section"><p>' + escapeHtml(feedback.rawText) + '</p></div></div>';
                return;
            }
            
            let html = '<div class="ai-feedback-card"><div class="ai-feedback-header"><span class="ai-icon">ü§ñ</span><span>AI Writing Analysis</span><span class="ai-disclaimer">(Teacher reference only)</span></div>';
            
            if (feedback.overallImpression) html += '<div class="ai-feedback-section"><strong>Overall Impression:</strong><p>' + escapeHtml(feedback.overallImpression) + '</p></div>';
            if (feedback.strengths?.length) html += '<div class="ai-feedback-section ai-strengths"><strong>‚úì Strengths:</strong><ul>' + feedback.strengths.map(s => '<li>' + escapeHtml(s) + '</li>').join('') + '</ul></div>';
            if (feedback.areasToImprove?.length) html += '<div class="ai-feedback-section ai-improvements"><strong>‚ñ≥ Areas to Improve:</strong><ul>' + feedback.areasToImprove.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul></div>';
            if (feedback.grammarNotes?.length) html += '<div class="ai-feedback-section"><strong>Grammar Notes:</strong><ul>' + feedback.grammarNotes.map(g => '<li>' + escapeHtml(g) + '</li>').join('') + '</ul></div>';
            if (feedback.vocabularyNotes?.length) html += '<div class="ai-feedback-section"><strong>Vocabulary Notes:</strong><ul>' + feedback.vocabularyNotes.map(v => '<li>' + escapeHtml(v) + '</li>').join('') + '</ul></div>';
            if (feedback.suggestedScore) html += '<div class="ai-feedback-section ai-score-suggestion"><strong>üí° Suggested Score Range:</strong> ' + escapeHtml(feedback.suggestedScore.range) + '<br><small>' + escapeHtml(feedback.suggestedScore.reasoning) + '</small></div>';
            if (feedback.teacherTip) html += '<div class="ai-feedback-section ai-teacher-tip"><strong>üéØ Teacher Tip:</strong> ' + escapeHtml(feedback.teacherTip) + '</div>';
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ============================================
        // SPEAKING FEEDBACK
        // ============================================
        
        async function getSpeakingAIFeedback() {
            const btn = document.getElementById('aiSpeakingBtn');
            const container = document.getElementById('aiSpeakingFeedback');
            if (!btn || !container) return;
            
            const notesTextarea = document.querySelector('textarea[name="speaking_notes"]');
            if (!notesTextarea || !notesTextarea.value.trim() || notesTextarea.value.trim().length < 10) {
                showNotification('Please add your observation notes first', 'error');
                return;
            }
            
            const levelData = testData[selectedLevel];
            let speakingQuestions = '';
            if (levelData?.Speaking) {
                const part1 = levelData.Speaking.part1?.join('; ') || '';
                const part2 = levelData.Speaking.part2 || '';
                speakingQuestions = 'Part 1: ' + part1 + '\nPart 2: ' + part2;
            }
            
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = 'ü§ñ Analyzing...';
            container.innerHTML = '<div class="ai-loading">Analyzing speaking performance...</div>';
            
            const prompt = `You are an English speaking assessment assistant helping teachers evaluate student speaking performance. Provide CEFR-aligned feedback.

STUDENT LEVEL: ${selectedLevel}
SPEAKING QUESTIONS/TOPICS: ${speakingQuestions || 'General speaking assessment'}

TEACHER'S OBSERVATION NOTES:
---
${notesTextarea.value}
---

Based on these notes, provide structured feedback as ONLY valid JSON (no markdown, no code blocks):

{
    "fluencyAssessment": "2 sentences about speech flow, pace, and hesitation patterns",
    "pronunciationNotes": "observations on pronunciation, stress, and intonation",
    "grammarInSpeech": "grammar patterns observed in spoken responses",
    "vocabularyRange": "assessment of vocabulary use and appropriateness",
    "interactionSkills": "ability to engage, respond to questions, maintain conversation",
    "suggestedCEFR": {
        "level": "A1 or A2 or B1 or B2 or C1",
        "confidence": "high or medium or low",
        "reasoning": "why this level seems appropriate"
    },
    "followUpSuggestions": ["suggested follow-up question 1", "question 2"],
    "teacherTip": "one actionable suggestion for helping this student improve"
}

RULES:
- Base assessment on teacher's notes, not assumptions
- Align to ${selectedLevel} expected performance
- Be specific but concise
- This is TEACHER ASSISTANCE only
- Output ONLY the JSON object, nothing else`;
            
            try {
                showNotification('ü§ñ AI is analyzing...', 'info');
                const result = await callGeminiAPI(prompt);
                
                if (result) {
                    displaySpeakingFeedback(container, result);
                    showNotification('‚úì AI analysis complete', 'success');
                } else {
                    container.innerHTML = '<div class="ai-error">Could not generate feedback. Please try again.</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="ai-error">An error occurred. Please try again.</div>';
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = 'ü§ñ Get AI Assessment Help';
            }
        }
        
        function displaySpeakingFeedback(container, feedback) {
            if (!container || !feedback) return;
            
            if (feedback.rawText) {
                container.innerHTML = '<div class="ai-feedback-card"><div class="ai-feedback-header"><span class="ai-icon">ü§ñ</span><span>AI Feedback</span></div><div class="ai-feedback-section"><p>' + escapeHtml(feedback.rawText) + '</p></div></div>';
                return;
            }
            
            let html = '<div class="ai-feedback-card"><div class="ai-feedback-header"><span class="ai-icon">ü§ñ</span><span>AI Speaking Assessment</span><span class="ai-disclaimer">(Teacher reference only)</span></div><div class="ai-feedback-grid">';
            
            if (feedback.fluencyAssessment) html += '<div class="ai-feedback-item"><strong>üó£Ô∏è Fluency:</strong><p>' + escapeHtml(feedback.fluencyAssessment) + '</p></div>';
            if (feedback.pronunciationNotes) html += '<div class="ai-feedback-item"><strong>üîä Pronunciation:</strong><p>' + escapeHtml(feedback.pronunciationNotes) + '</p></div>';
            if (feedback.grammarInSpeech) html += '<div class="ai-feedback-item"><strong>üìù Grammar:</strong><p>' + escapeHtml(feedback.grammarInSpeech) + '</p></div>';
            if (feedback.vocabularyRange) html += '<div class="ai-feedback-item"><strong>üìö Vocabulary:</strong><p>' + escapeHtml(feedback.vocabularyRange) + '</p></div>';
            
            html += '</div>';
            
            if (feedback.interactionSkills) html += '<div class="ai-feedback-section"><strong>üí¨ Interaction Skills:</strong><p>' + escapeHtml(feedback.interactionSkills) + '</p></div>';
            if (feedback.suggestedCEFR) html += '<div class="ai-feedback-section ai-cefr-suggestion"><strong>üìä Suggested CEFR Level:</strong> <span class="cefr-badge">' + escapeHtml(feedback.suggestedCEFR.level) + '</span> (' + escapeHtml(feedback.suggestedCEFR.confidence) + ' confidence)<br><small>' + escapeHtml(feedback.suggestedCEFR.reasoning) + '</small></div>';
            if (feedback.followUpSuggestions?.length) html += '<div class="ai-feedback-section"><strong>‚ùì Suggested Follow-up Questions:</strong><ul>' + feedback.followUpSuggestions.map(q => '<li>' + escapeHtml(q) + '</li>').join('') + '</ul></div>';
            if (feedback.teacherTip) html += '<div class="ai-feedback-section ai-teacher-tip"><strong>üéØ Teacher Tip:</strong> ' + escapeHtml(feedback.teacherTip) + '</div>';
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ============================================
        // RECOMMENDATIONS / STUDY PLAN
        // ============================================
        
        async function getEnhancedRecommendations() {
            const btn = document.getElementById('aiRecommendationsBtn');
            const container = document.getElementById('aiEnhancedRecommendations');
            if (!btn || !container) return;
            
            const results = calculateAllResults();
            const existingRecs = document.querySelectorAll('.recommendation');
            let weakAreas = [];
            existingRecs.forEach(rec => weakAreas.push(rec.textContent));
            
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = 'ü§ñ Generating...';
            container.innerHTML = '<div class="ai-loading">Creating personalized study plan...</div>';
            
            const scores = {
                listening: results.sectionScores?.Listening || { score: 0, total: 0, percentage: 0 },
                reading: results.sectionScores?.Reading || { score: 0, total: 0, percentage: 0 },
                grammar: results.sectionScores?.Grammar || { score: 0, total: 0, percentage: 0 },
                overall: { score: results.totalScore, total: results.maxScore, percentage: results.percentage }
            };
            
            const prompt = `You are a language learning advisor. Based on assessment results, create a personalized study plan.

STUDENT LEVEL: ${selectedLevel}
ASSESSMENT SCORES: ${JSON.stringify(scores)}
IDENTIFIED WEAK AREAS: ${weakAreas.join('; ') || 'General improvement needed'}

Create actionable recommendations as ONLY valid JSON (no markdown, no code blocks):

{
    "priorityFocus": "the single most important area to focus on first",
    "weeklyPlan": {
        "week1": "specific focus and activities for week 1",
        "week2": "specific focus and activities for week 2"
    },
    "specificExercises": [
        {"skill": "listening/reading/writing/speaking/grammar", "activity": "specific exercise description", "frequency": "how often"},
        {"skill": "...", "activity": "...", "frequency": "..."},
        {"skill": "...", "activity": "...", "frequency": "..."}
    ],
    "freeResources": [
        {"name": "resource name", "type": "website/app/youtube", "url": "actual URL if known", "why": "why this helps"},
        {"name": "...", "type": "...", "url": "...", "why": "..."}
    ],
    "milestones": [
        {"timeframe": "1 week", "goal": "achievable goal"},
        {"timeframe": "1 month", "goal": "achievable goal"}
    ],
    "encouragement": "personalized motivational message based on their performance"
}

RULES:
- Maximum 3 exercises, 2 resources
- Resources must be real and free (BBC Learning English, British Council, Duolingo, YouTube channels like English with Lucy, etc.)
- Match difficulty to ${selectedLevel}
- Be specific and actionable
- Output ONLY the JSON object, nothing else`;
            
            try {
                showNotification('ü§ñ AI is generating study plan...', 'info');
                const result = await callGeminiAPI(prompt);
                
                if (result) {
                    displayEnhancedRecommendations(container, result);
                    showNotification('‚úì Study plan ready', 'success');
                } else {
                    container.innerHTML = '<div class="ai-error">Could not generate recommendations. Please try again.</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="ai-error">An error occurred. Please try again.</div>';
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = 'üéØ Generate Personalized Study Plan';
            }
        }
        
        function displayEnhancedRecommendations(container, recommendations) {
            if (!container || !recommendations) return;
            
            if (recommendations.rawText) {
                container.innerHTML = '<div class="ai-recommendations-card"><div class="ai-feedback-header"><span class="ai-icon">üéØ</span><span>AI Study Plan</span></div><div class="ai-feedback-section"><p>' + escapeHtml(recommendations.rawText) + '</p></div></div>';
                return;
            }
            
            let html = '<div class="ai-recommendations-card"><div class="ai-feedback-header"><span class="ai-icon">üéØ</span><span>Personalized Study Plan</span></div>';
            
            if (recommendations.priorityFocus) html += '<div class="ai-priority"><strong>üî• Priority Focus:</strong> ' + escapeHtml(recommendations.priorityFocus) + '</div>';
            
            if (recommendations.weeklyPlan) {
                html += '<div class="ai-feedback-section ai-weekly-plan"><strong>üìÖ 2-Week Plan:</strong><div class="week-plan">';
                if (recommendations.weeklyPlan.week1) html += '<div class="week"><strong>Week 1:</strong> ' + escapeHtml(recommendations.weeklyPlan.week1) + '</div>';
                if (recommendations.weeklyPlan.week2) html += '<div class="week"><strong>Week 2:</strong> ' + escapeHtml(recommendations.weeklyPlan.week2) + '</div>';
                html += '</div></div>';
            }
            
            if (recommendations.specificExercises?.length) {
                html += '<div class="ai-feedback-section"><strong>üìù Recommended Exercises:</strong><div class="exercises-list">';
                recommendations.specificExercises.forEach(e => {
                    html += '<div class="exercise-item"><span class="exercise-skill">' + escapeHtml(e.skill || '') + '</span><span class="exercise-activity">' + escapeHtml(e.activity || '') + '</span><span class="exercise-frequency">' + escapeHtml(e.frequency || '') + '</span></div>';
                });
                html += '</div></div>';
            }
            
            if (recommendations.freeResources?.length) {
                html += '<div class="ai-feedback-section"><strong>üîó Free Resources:</strong><ul class="resources-list">';
                recommendations.freeResources.forEach(r => {
                    html += '<li><strong>' + escapeHtml(r.name || '') + '</strong> <em>[' + escapeHtml(r.type || '') + ']</em>';
                    if (r.url && r.url !== '...') html += '<br><a href="' + escapeHtml(r.url) + '" target="_blank" rel="noopener">' + escapeHtml(r.url) + '</a>';
                    html += '<br><small>' + escapeHtml(r.why || '') + '</small></li>';
                });
                html += '</ul></div>';
            }
            
            if (recommendations.milestones?.length) {
                html += '<div class="ai-feedback-section ai-milestones"><strong>üèÜ Milestones:</strong><div class="milestones-list">';
                recommendations.milestones.forEach(m => {
                    html += '<div class="milestone"><span class="milestone-time">' + escapeHtml(m.timeframe || '') + '</span><span class="milestone-goal">' + escapeHtml(m.goal || '') + '</span></div>';
                });
                html += '</div></div>';
            }
            
            if (recommendations.encouragement) html += '<div class="ai-encouragement">üí™ ' + escapeHtml(recommendations.encouragement) + '</div>';
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Set up real-time listeners
                setupLessonsListener();
                setupAssessmentsListener();
                
                // Initial load
                await Promise.all([
                    loadLessonsFromFirebase(),
                    loadAssessmentsFromFirebase()
                ]);
                
                updateConnectionStatus(true);
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show dashboard
                showView('dashboard');
                
                console.log('App initialized with Firebase');
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div style="text-align:center">
                        <div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>
                        <div style="color:#dc2626;font-size:18px;margin-bottom:8px">Connection Error</div>
                        <div style="color:#64748b">Please check your internet connection and refresh the page.</div>
                        <button onclick="location.reload()" style="margin-top:20px;padding:12px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer">Retry</button>
                    </div>
                `;
                updateConnectionStatus(false);
            }
        });

        // Monitor online/offline status
        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));
    </script>
</body>
</html>
